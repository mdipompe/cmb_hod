<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 7.1 (456449)"/><meta name="author" content="mdipompe@gmail.com"/><meta name="created" content="2017-06-05 21:04:44 +0000"/><meta name="latitude" content="43.7053"/><meta name="longitude" content="-72.28633055555555"/><meta name="source" content="desktop.mac"/><meta name="updated" content="2018-04-30 19:57:38 +0000"/><title>CMB HOD</title></head><body><div>6/5/16</div><hr/><div>Been touching on and off of this for years, but looking back into using the mean CMB kappa values around quasars to constrain the HOD (as well as look for differences in HOD between obscured and unobscured).</div><div><br/></div><div>From a while back, I made these figures that went around to Ryan et al.:</div><div><img src="CMB%20HOD.resources/604CAEBF-F5BD-4CA0-B2A1-1B6DAEFC041C.png" height="675" width="825"/><img src="CMB%20HOD.resources/8B0AB826-3678-4F28-910E-8D3695484BF1.png" height="675" width="825"/><br/></div><div>Fuzzy on the details, but remember something making me think that these weren’t quite right (but of some kind in tracking the annuli and properly putting it all together).</div><div><br/></div><div>Over the last few months here and there wrote some code from scratch to do this, relying on the HEALPix tool query_disk, which I wasn’t using before.  Still want to do some testing, but doesn’t look nearly as clean as those did, even with many more quasars.</div><div>E.g. for the obscured sample over the whole sky:</div><div><img src="CMB%20HOD.resources/337936DC-8C08-4077-BA0F-D3A1751FFE83.png" height="540" width="1002"/><br/></div><div>Still need to do some checking.</div><div><br/></div><div>From Adam a while back, with some suggestions on the theory:</div><div><span style="font-size: 14px; letter-spacing: normal; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(0, 0, 0); font-family: Helvetica; font-variant-caps: normal;">"The full formalism on all scales ends up looking like Equation 15 from this paper:</span></div><div style="font-size: 14px; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><a style="font-size: 14px; letter-spacing: normal; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(0, 0, 0); font-family: Helvetica; font-variant-caps: normal;" href="http://arxiv.org/pdf/1101.4143v3.pdf">http://arxiv.org/pdf/1101.4143v3.pdf</a></div><div style="font-size: 14px; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><span style="font-size: 14px; letter-spacing: normal; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(0, 0, 0); font-family: Helvetica; font-variant-caps: normal;">and I think that paper has a rather nice description of how the various terms enter into the calculation. Unfortunately, you'd also need to de-project from real-space to an angular scale.  Perhaps a straightforward approach would be to determine whether the NFW (or another profile such as the King profile or SIS) is a good fit on small scales? The math is (a little) easier, then. This is a fairly complete description:</span></div><div style="font-size: 14px; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><a style="font-size: 14px; letter-spacing: normal; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(0, 0, 0); font-family: Helvetica; font-variant-caps: normal;" href="http://arxiv.org/pdf/astro-ph/0003205v1.pdf">http://arxiv.org/pdf/astro-ph/0003205v1.pdf</a></div><div style="font-size: 14px; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><span style="font-size: 14px; letter-spacing: normal; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(0, 0, 0); font-family: Helvetica; font-variant-caps: normal;">And has a nice set of expressions for K(theta) in terms of a chosen density profile.</span></div><div style="text-align: start; text-indent: 0px;"><span style="text-indent: 0px; font-size: 14px; letter-spacing: normal; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(0, 0, 0); font-family: Helvetica; font-variant-caps: normal;">My suspicion, though, is that the effects of the density profile manifest mainly on angular scales corresponding to your first few plotted bins. So, there may not be any power with which to distinguish between the obscured and unobscured quasars.</span><span style="text-indent: 0px; font-family: Helvetica;">”</span></div><div style="font-size: 14px; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><br/></div><div style="font-size: 14px; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><br/></div><div style="text-align: start; text-indent: 0px;"><span style="text-indent: 0px; font-size: 14px; letter-spacing: normal; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(0, 0, 0); font-family: Helvetica; font-variant-caps: normal;">Some more careful testing of code</span><span style="text-indent: 0px; font-family: Helvetica;">…</span></div><div style="font-size: 14px; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><span style="font-size: 14px; letter-spacing: normal; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(0, 0, 0); font-family: Helvetica; font-variant-caps: normal;">Definitely identifying rings around single points:</span></div><div style="font-size: 14px; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><div><img src="CMB%20HOD.resources/CBFED217-C935-4EED-912F-6E0F24A25568.png" height="874" width="1588"/><br/></div></div><div style="font-size: 14px; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><span style="font-size: 14px; letter-spacing: normal; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(0, 0, 0); font-family: Helvetica; font-variant-caps: normal;">And multiple points:</span></div><div style="font-size: 14px; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><div><img src="CMB%20HOD.resources/7A174315-A583-46E3-BDDC-32B0529107A0.png" height="441" width="795"/><br/></div></div><div style="font-size: 14px; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><span style="font-size: 14px; letter-spacing: normal; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(0, 0, 0); font-family: Helvetica; font-variant-caps: normal;">By inputting these fake values in rings around points, I think I’m fairly convinced that things are working as expected, including accounting for masked pixels and pixels with more than one target (which are weighted in the final kappa mean).</span></div><div style="font-size: 14px; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><br/></div><div style="font-size: 14px; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><span style="font-size: 14px; letter-spacing: normal; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(0, 0, 0); font-family: Helvetica; font-variant-caps: normal;">Ok, passed all the checks I can think of!  BUT - realized that in my actual runs of this on the data, was only using the Planck mask, not the full WISE+SDSS+Planck mask, which could certainly mess some things up!</span></div><div style="font-size: 14px; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><br/></div><div style="font-size: 14px; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><span style="font-size: 14px; letter-spacing: normal; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(0, 0, 0); font-family: Helvetica; font-variant-caps: normal;">Ok, redone and looks more promising (though it is different from the old, original version, indicating some bugs have been worked out - also faster!):</span></div><div style="font-size: 14px; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><div><img src="CMB%20HOD.resources/92A28728-8EE8-48EB-824C-301690AD3E6E.png" height="571" width="763"/><br/></div></div><div style="font-size: 14px; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><div><span style="font-size: 14px; color: rgb(0, 0, 0); font-family: Helvetica; font-variant-caps: normal;">Will get a much better signal using all wise quasars on the whole sky, but will take some time to run given large sample (Update: finished this and added points to plot above - nothing too exciting, behaves as expected falling generally between obscured/unobscured)</span></div></div><div><br/></div><div>Should note that as Ryan pointed out, this result is something like the integral of the CMB cross-correlation I’ve already done (not sure of exact mathematical relationship though…).  As you can see there are many similarities in the shape, e.g. the bump in the obscured sample at around 0.1-0.2 deg.</div><div><br/></div><div>Distribution of kappa around DES WISE quasars using SPT maps?</div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div>11/6/17</div><div><hr/><div>Back to thinking about this again, and maybe just using one vs two halo formalism and the lensing x-corr that I’ve already done.</div></div><div><br/></div><div>This paper talks a bit about the small scales of CMB lensing maps, but is not directly talking about cross-correlation with (baryonic) tracers, and therefore not directly constraining HOD:</div><div><a href="https://arxiv.org/abs/1710.03747v1">https://arxiv.org/abs/1710.03747v1</a></div><div><br/></div><div>But this one does, and actually breaks the contributions of the cross-correlation into a one and two halo term (though this is for CMB-galaxy lensing map cross correlations, as opposed to galaxy density):</div><div><a href="https://arxiv.org/pdf/1504.05598.pdf">https://arxiv.org/pdf/1504.05598.pdf</a></div><div><img src="CMB%20HOD.resources/8ED0CF8E-E4EC-4070-9EF4-41459B65C4C0.png" height="465" width="637"/><br/></div><div>Say they use the halo-model with these as refs:</div><div><a href="http://adsabs.harvard.edu/abs/2000MNRAS.318..203S">http://adsabs.harvard.edu/abs/2000MNRAS.318..203S</a></div><div><a href="http://adsabs.harvard.edu/abs/2002PhR...372....1C">http://adsabs.harvard.edu/abs/2002PhR...372....1C</a></div><div>Using the methodology of these two (with the tSZ signal replaced with galaxy lensing in their case):</div><div><a href="https://arxiv.org/abs/1312.4525">https://arxiv.org/abs/1312.4525</a></div><div><a href="https://arxiv.org/abs/1412.5593">https://arxiv.org/abs/1412.5593</a></div><div><br/></div><div>From Seljak 2000 (<a href="http://adsabs.harvard.edu/abs/2000MNRAS.318..203S">http://adsabs.harvard.edu/abs/2000MNRAS.318..203S</a>), have a 2-halo power spectrum term:</div><div><img src="CMB%20HOD.resources/08E185D1-26D8-4DD4-B36B-BBA045747877.png" height="77" width="632"/><br/></div><div>And a 1-halo term (labeled with a “P” as the “Poisson” term):</div><div><img src="CMB%20HOD.resources/D8658B59-A091-42E1-B3E5-A8B1A6F9A3D2.png" height="335" width="629"/><br/></div><div><img src="CMB%20HOD.resources/2A6E2D7E-1E5E-4735-A1FB-C7855E97B822.png" height="593" width="629"/><br/></div><div>Now, in terms of the cross-correlation in an angular space with CMB maps, most relevant equations are from Hill &amp; Spergel (<a href="https://arxiv.org/abs/1312.4525">https://arxiv.org/abs/1312.4525</a>). For the one-halo term in a cross-correlation of CMB and tSZ maps:</div><div><img src="CMB%20HOD.resources/B0E733C0-99BC-470F-9AF0-3E088739EBAD.png" height="414" width="1085"/><br/></div><div>And the 2-halo term:</div><div><br/></div><div><img src="CMB%20HOD.resources/ECC9C62D-0C8E-4283-AA48-4EF9E55AC157.png" height="107" width="1301"/><br/></div><div>which, in the limit of large scales (and what is typically assumed in most CMB x-corr work, including ours), simplifies to:</div><div><img src="CMB%20HOD.resources/7DC7CAF5-E385-4EEE-ADC3-D22D6ACB4B60.png" height="171" width="940"/><br/></div><div>Note that they are working in phi (potential) space, rather than kappa (convergence) space. According to Battaglia et al. (2008; <a href="https://arxiv.org/abs/1412.5593">https://arxiv.org/abs/1412.5593</a>), switching between these two in multipole (ell) space is trivial (they also have very similar equations as above for the 1 and 2 halo cross-correlation terms):</div><div><img src="CMB%20HOD.resources/A961E884-B076-4706-8A34-83A3B0940296.png" height="40" width="261"/><br/></div><div><br/></div><div>So, the question for our case is how do we change the y_l terms (the tSZ ones) into the quasar density terms? </div><div><br/></div><div>Since the y_l terms are the Fourier transform of the Compton y profiles, which are defined by the pressure profile within a halo (and similarly the phi terms are the Fourier transform of the convergence profile, which just depends on the mass profile of a halo, generally using NFW), does this just mean that in our case we want the Fourier transform of the galaxy/AGN distribution in a given halo? I.e., the occupation function parametrized by central and satellites as in e.g. Richardson et al. (2013):</div><div><img src="CMB%20HOD.resources/F6B3BBF5-7759-46B8-8F7B-DCA9CC9FDFDD.png" height="125" width="376"/><br/></div><div>But this does’t make a lot of sense, since there is no spatial information. So we need something about how galaxies populate halos, spatially. Next in the Richardson paper, say they assume that central and satellite halos are independent (don’t need a central to have satellites), and the centrals have a nearest integer distribution (Berlind &amp; Weinberg 2002 - will look up in a minute), and the satellites have an NFW profile with concentration-mass profiles of:</div><div><img src="CMB%20HOD.resources/931F7395-6F30-4350-8A15-3FC88285BF59.png" height="71" width="501"/><br/></div><div>(M_* is non-linear mass for collapse at z=0, so I can calculate that, and c_0 is 32 motivated by high concentration for nearby AGN)</div><div><br/></div><div>So I should just be able to use an NFW profile with these parameters, and not really change a whole lot from the galaxy lensing version (since that is based on an NFW profile as well).</div><div><br/></div><div>The NFW profile is:</div><div><br/></div><div><img src="CMB%20HOD.resources/30752C50-5853-44F8-8BD1-BF6758812015.png" height="138" width="394"/>, <img src="CMB%20HOD.resources/DFD04E20-A7ED-471B-9B52-6ECC2B1A67D2.png" height="66" width="212"/>with R_vir generally = R_200.</div><div>So I think I can put this all together, with two NFW profiles - one for the dark matter density in the CMB lensing term, and one for the galaxy distribution within the halo for the distribution kernel term.</div><div><br/></div><div><br/></div><div>11/15/17</div><div><hr/><div>Been working on this on paper to put it all together, and think I have most of this worked out.</div></div><div><br/></div><div>Working on coding things up, and need to make some choices about which specific equations to use. Starting with the NFW profile:</div><div><img src="CMB%20HOD.resources/30752C50-5853-44F8-8BD1-BF6758812015.png" height="138" width="394"/>, <img src="CMB%20HOD.resources/DFD04E20-A7ED-471B-9B52-6ECC2B1A67D2.png" height="66" width="212"/> (NFW 97)</div><div><br/></div><div>Note that R_vir is a bit complicated, per Hill &amp; Spergel (2014) (also NFW 97, but theirs is more complicated and I don’t like the units):</div><div><img src="CMB%20HOD.resources/35DB5A4C-6E1D-4F05-9C13-EC9904B77A88.png" height="97" width="457"/><br/></div><div>with </div><div><img src="CMB%20HOD.resources/9D0BE4C3-4149-46BD-8BB1-979F494D45DC.png" height="41" width="721"/><br/></div><div>and </div><div><img src="CMB%20HOD.resources/8ADC26D0-C3CF-49A4-8C69-6586352EDC97.png" height="89" width="392"/><br/></div><div><br/></div><div>In the case of DM, the rho_0 term is:</div><div><img src="CMB%20HOD.resources/DCC986FE-F903-485B-8BD5-D7F1279BCB53.png" height="34" width="179"/><br/></div><div>with:</div><div><img src="CMB%20HOD.resources/85ECBB1C-3435-4C13-A935-7579383F4295.png" height="81" width="188"/>    (I’m not 100% if this is always the current value or the value at z you are interested in? I think it’s the latter, see Hill &amp; Spergel 2014)</div><div><br/></div><div>The delta_c term is NOT the critical density for collapse (~1.68), but rather depends on the concentration index c (UPDATE: rather than using 200 there, use Delta_cr(z) from above!):</div><div><img src="CMB%20HOD.resources/16B1C7D3-82E2-47E7-9BA0-566A3E9E16A0.png" height="95" width="381"/>   (NFW 97)</div><div>The concentration index has a few different definitions. One is:</div><div><img src="CMB%20HOD.resources/C52D0836-C3C1-4CB8-8793-37FBE6E0CCDE.png" height="96" width="286"/>  (e.g. Zheng et al. 2007, Richardson et al. 2013)</div><div>Beta is ~-0.13, c0~11, and M* is the non-linear mass for collapse, which according to here: <a href="https://arxiv.org/pdf/1205.5556.pdf">https://arxiv.org/pdf/1205.5556.pdf</a> (eq 8) is the mass for which sigma_M equals delta_crit</div><div><br/></div><div>Another is:</div><div><img src="CMB%20HOD.resources/4F349DB1-99A4-4DB7-9F03-4A1CFC90904E.png" height="96" width="360"/> (Duffy et al. 2008, constants in their table 1)</div><div>With M_p = (2x10^12)/h</div><div><br/></div><div>These lead to pretty similar profiles that only differ on small scales (note they line up exactly with a c0 value of 8 in Zheng, instead of 11 as shown below):</div><div><img src="CMB%20HOD.resources/06094253-C899-4F65-A6CE-B7D5E9C05A2D.png" height="482" width="688"/><br/></div><div><br/></div><div>I’m going to adopt the Zheng et al. profiles, which allows me to just vary the concentration profiles (higher for baryons/galaxies).</div><div><br/></div><div>Of course, switching to the galaxy number density instead of a mass density of DM, the rho_0 normalization changes. Here, I think we need to define it to be the average number density:</div><div><img src="CMB%20HOD.resources/F1E02CE5-E288-452F-A3FB-F6C1A5CB1D50.png" height="77" width="312"/><br/></div><div>Where &lt;N(M&gt; is in the HOD formalism:</div><div><img src="CMB%20HOD.resources/D46C1F90-F7CE-43DA-A550-CCEB9E09A43B.png" height="90" width="1019"/><br/></div><div>The first term is for centrals, the second term is for satellites.</div><div>The parameters in here will be the free parameters that I need to fit to the CMB lensing cross-correlation. To limit the number of parameters, they say they fix M_cut to be &lt;&lt; 10^12, but not sure of exact value.  Also, not sure what values I would adopt for our fiducial model…</div><div><br/></div><div>V above is the volume of the halo, which will just be 4/3*pi*R_vir^3.  Note that I’m assuming throughout that R_200=R_vir (and thus M_vir = M_200)</div><div><br/></div><div><br/></div><div>Here’s how my NFW profile shape turns out (in these units for direct comparison to NFW below):</div><div><img src="CMB%20HOD.resources/1E054211-36C3-467F-8CB0-8896D7260172.png" height="706" width="1158"/><img src="CMB%20HOD.resources/114EFC4C-898C-4BA5-B1A0-BDB3DB4D2F48.png" height="566" width="1084"/><br/></div><div>They’re close, but not quite the same. However, I use slightly different cosmology and definitions of things like the concentration index (which I’m adopting from Zheng et al and others).</div><div><br/></div><div>But if I integrate the profile to get a mass:</div><div><img src="CMB%20HOD.resources/75830ADA-6D37-4AFD-BD40-23494875DA96.png" height="80" width="299"/><br/></div><div>I don’t get the initial mass back, it’s always too high. So something isn’t quite right…</div><div><br/></div><div>11/16/17</div><div><hr/><div>Ok, I fixed the virial radius, which I was just defining using the mean matter density (rho_crit * Omega_m), as I do in my HMF code (based on many others). Apparently that’s not the same thing, because Hill &amp; Spergel as well as others (NFW) have much more complicated R_vir equations (see corrected notes above).  </div></div><div><br/></div><div>If I do this, my figures look quite similar to NFWs, modulo differences in cosmology and not exact matching of halo masses to compare:</div><div><img src="CMB%20HOD.resources/9A2FDC04-F0E6-4406-96F2-8FC3C8F8E928.png" height="824" width="1010"/><br/></div><div>Integrating these profiles out to the virial radius (which is about 1.2 Mpc for the massive halo, and 0.06 Mpc for the small one), now returns a value very similar to the input mass.  E.g. input M=10^15. (M_sun/h) I get back 1.29e15 M_sun/h, and for 10^11 I get back 1.28e11.  Is that close enough to be satisfied? Maybe some other factors that are slightly off, like a little h somewhere?</div><div><br/></div><div><br/></div><div>For now, moving on to projected version. Using equations from Bartelmann (1996):</div><div><br/></div><div><img src="CMB%20HOD.resources/5BF544F7-3CF5-4189-86B9-934250ED7454.png" height="314" width="549"/><br/></div><div>where rho_s is just rho_crit*delta_c as before in the 3D version, and x is just r/r_s</div><div><br/></div><div>Looks similar to 3D profile:</div><div><img src="CMB%20HOD.resources/0F45BE6D-67CD-4678-B489-B622A6293F24.png" height="776" width="840"/><br/></div><div>If I integrate to get the mass:</div><div><img src="CMB%20HOD.resources/83999831-DC43-43E2-959C-80B69FF05CD7.png" height="80" width="290"/><br/></div><div>I get 1.73e15 and 1.51e11.  Again, not exactly the input, but still not sure if this should worry me or not…</div><div><br/></div><div><br/></div><div>Moving on to galaxy distribution, instead of dark matter. Need to determine what the rho_s term in the numerator of NFW profile is in this case.  The normalization must be set so that the integral of the profile gives you the mean number of galaxies (or AGN or whatever).  Worked this out using integrator:</div><div><img src="CMB%20HOD.resources/F273204E-199E-4020-A7FA-C3B65F1EA342.png" height="1248" width="1346"/><br/></div><div>Just depends on all terms that I already have calculated, straightforward to put in!</div><div><br/></div><div>Coded up the functions for the HOD, for now using the parameters from Richardson et al. 2013:</div><div><img src="CMB%20HOD.resources/828CB446-6A1B-49CB-BD7F-C332D985059F.png" height="726" width="962"/><br/></div><div>From Richardson:</div><div><img src="CMB%20HOD.resources/AF4C1F68-C3C5-469F-BA9B-5C6B844D10F9.png" height="448" width="614"/><br/></div><div><br/></div><div>Total &lt;N(M)&gt; for halo masses of 10^15 and 10^11 are 58.6961 and 7.773e-7, respectively (for checking the profiles)</div><div><br/></div><div>The number density profiles look like:</div><div><img src="CMB%20HOD.resources/CC319909-A97E-49BA-A8CE-55A9395CB7BD.png" height="736" width="908"/><br/></div><div>Integrating these gives back 58.693 and 7.567e-7, quite close to the expected values!</div><div><br/></div><div>And finally for the galaxies in projected density:</div><div><img src="CMB%20HOD.resources/6E1EFFB6-017F-4B23-9B06-DE0A2D25AE17.png" height="710" width="1182"/><br/></div><div>But for some reason, integrating these doesn’t give the right numbers, get ~70 and 8e-7. So right OoM, but more off than when I did the projection in mass.</div><div><br/></div><div><br/></div><div>11/17/19</div><div><hr/><div>Been toying all day with my codes (fixed a slight bug in calculation of M_star, in the concentration index - I think based on NFW 97 that it is set to the mass such that sigma(M, z=0) equals delta_crit(z), whereas before I used delta_crit(z=0).  In the end, this adjusts the total masses I integrate from the profiles very slightly.</div></div><div><br/></div><div>What i see now is that in all masses, the value I get from integrating the profile gives me a mass too large by a factor of 1/0.77. That 0.7 factor makes me really think that there’s an h missing somewhere, but that really does not appear to be the case.</div><div><br/></div><div>Other possibility is that I’m not calculating the same mass as the input mass. For example, in the summary here: <a href="https://arxiv.org/pdf/astro-ph/0412161.pdf">https://arxiv.org/pdf/astro-ph/0412161.pdf</a>, find that M_halo = 1.1 M_vir = 1.9 M_200.</div><div><br/></div><div>The value I’m calculating is M_vir (since I integrate to R_vir, as defined by Hill and Spergel).  What if I do M_200? Find the radius for which the density equals 200*mean density (where the mean density is rho_crit*omega_m, both at z=0 since in comoving coordinates the mean density does not evolve).  </div><div><br/></div><div>If I do that, then for input logM=15 (Msun/h), I get back 2.26e15.  The ratio of this and M_vir is 1.75…suspiciously close to the ratio of 1.9/1.1=1.73.  BUT, the ratio of the input mass to the viral mass is not 1.1, but rather ~1.3.</div><div><br/></div><div>Since the galaxy number density results seem pretty spot on, it would seem that if there is any issue in factors of h, they must be in the masses or critical density...</div><div><br/></div><div>Thinking about the projected values, these are farther off than expected. Is this because the limit of the integral in the projected case should be smaller (i.e. the projected virial radius is not the same?). Some possible insight (and checks on equations) in here:</div><div><a href="http://adsabs.harvard.edu/abs/2001MNRAS.321..155L">http://adsabs.harvard.edu/abs/2001MNRAS.321..155L</a></div><div><br/></div><div><br/></div><div>11/20/17</div><div><hr/><div>Used the equations from L&amp;M01 in the link above, and there is a slight difference in the normalizations:</div></div><div><br/></div><div><img src="CMB%20HOD.resources/4C32BE67-AC4A-457C-9B7D-0860F6DB1E29.png" height="356" width="504"/><br/></div><div>Dividing the two, the difference is a factor of 1.29…precisely how much my integral for the input mass was off before.  However, that was for the unprojected, not projected mass…the projected masses were slightly more off.  </div><div><br/></div><div>So this implies that there is an issue in the normalization of my NFW profile, in the rho_s = delta_c*rho_crit term, since that is in both of the 3D and projected versions, and this factor is off in both (assuming that the normalization in the L&amp;M01 version is correct, which it seems like it is since that will give a consistent input vs integrated mass).</div><div><br/></div><div>Comparing the two normalization factors:</div><div>L&amp;M:</div><div><img src="CMB%20HOD.resources/72940754-D03F-4C03-A260-1070518A6DD5.png" height="178" width="224"/><br/></div><div>and Bartelmann:</div><div><img src="CMB%20HOD.resources/13A91389-8DE5-422D-888D-4E0470D40D64.png" height="148" width="1112"/><br/></div><div>Under the assumption that </div><div><img src="CMB%20HOD.resources/28F67DC0-6B31-4FCE-8DE4-C9C9016D9A78.png" height="178" width="504"/><br/></div><div>These two expressions reduce to equate exactly.</div><div><br/></div><div>So the issue must be in the rho_crit term…but as far as I can tell everything in the rho_crit code is correct.</div><div><br/></div><div>Also note that the difference in the normalizations (and this the input vs. integrated mass is a function of z - difference gets smaller for increasing z).</div><div><br/></div><div>Possible clue - Hill &amp; Spergel point out that the mean matter density should be constant with z in comoving coordinates, which obviously makes sense. But if rho_mean = rho_crit * omega_m, that doesn’t seem to be the case.</div><div><img src="CMB%20HOD.resources/4F4D40D0-D999-4B50-B915-7746E1AD1CBD.png" height="712" width="1250"/><br/></div><div><br/></div><div>My critical density is independent of h, as it should be in comoving coordinates, so it seems all factors of h are accounted for.</div><div><br/></div><div>Aha - because H evolves, little h does too, and this needs to be accounted for the the dividing out of the h factors in g.  Need little_h(z) first, then calculate G.  This gives constant rho_crit and thus rho_m with z, in comoving coords.  Which I think is right…though Hill and Spergel only specify that mean rho is constant, not rho_crit…</div><div><br/></div><div>But even if this is right (not positive yet), doesn’t change end result - the two normalizations differ by the same factor, as they both change in tandem. rho_crit only enters one of them via the calculation of the viral radius, so something there?</div><div><br/></div><div>Aha - if I change the delta_cr term in the calculation of r_vir to just 200, rather than the equation from Hill &amp; Spergel, things match up just fine.  So I think the issue here is that r_vir is being calculated with that evolving value (rather than just an assumed value of 200), while the delta_c term from NFW 97 has a 200 built in.  Need to change that 200 factor, and I think I’m good…</div><div><br/></div><div>Now on the 3D profile, integrating the mass gives me the input mass within &lt;1% for both 10^11 and 10^15 masses!</div><div><br/></div><div>Double check with Ryan about the rho_mean, rho_crit vs z issue…need some sanity check on that.</div><div><br/></div><div>11/21/17</div><div><hr/><div>Now that the 3D version is working, back to what set this all off - the projected version.</div></div><div><br/></div><div>Now, integrating the projected mass density out to Rvir gives halo masses too large, but by a mass dependent amount. The 10^15 halo gives 1.324d15, and the 10^11 halo gives 1.17d11.  Right OoM, but </div><div><br/></div><div><br/></div><div><br/></div><div>Some remaining questions:</div><div>1) Why is r_halo different from r_vir, when calculating e.g. sigma(M)? (Is it still with the fixes I’ve put in?)</div><div>2) What is the behavior of rho_crit in comoving units with z? Constant or no? If no how is mean rho constant?</div><div>3) Why aren’t projected integrals working?</div><div><br/></div><div><br/></div><div>11/25/17</div><div><hr/><div>Ryan made good suggestion to numerically integrate the 3D profile into the 2D, rather than using the analytic solution to see what’s up.</div></div><div><img src="CMB%20HOD.resources/F8E3BB9E-09C5-4C22-907A-4605BACD1309.png" height="258" width="862"/><br/></div><div>Plugging that top integral in gives me pretty good agreement (red is integrated, white analytic):</div><div><img src="CMB%20HOD.resources/2D4D1655-0C6F-47EC-B10F-CF38928718EF.png" height="716" width="1204"/><br/></div><div>The integrated versions deviates at the edges, I think just due to the accuracy of the estimation - particularly on large scales, not integrating to infinity.  So my projected version seems just fine, despite giving wrong mass. </div><div><br/></div><div>Last thing to check is the limit of integration - it’s probably not R_vir, but some projected R_vir.</div><div><br/></div><div>If you project the viral radius onto the sky (rvir_p = rvir*cos(theta)) and take the mean value over all angles (-90 to 90), you get that rvir_p = (2/pi)*rvir.</div><div><br/></div><div>But, integrating out to this radius doesn’t quite give the right masses - it gives 9.18e14 and 9.14e10 for my test masses. Too small by ~9%.</div><div><br/></div><div>If I use the analytic mass solution:</div><div><img src="CMB%20HOD.resources/3D4EF730-F5CE-4197-AB34-094AEF70E66C.png" height="144" width="934"/><br/></div><div>This doesn’t agree with my numeric integral, out to the same radius. Integrating gives me 9.18e14, analytic 2.13e15.</div><div><br/></div><div>11/28/17</div><div><hr/><div>Ryan made the good point that the projected mass density by default includes things out beyond the virial radius by default, as it has to include everything along a given line of sight. So the projected mass at a given projected radius includes everything behind that radius, not just out to the real virial radius. So the radius you need to integrate to in projected space is a complicated function of the shape of the profile!</div></div><div><br/></div><div>Since I only needed this as a check anyway, and I know my 3D profile is fine and my analytic 2D one matches the integrated 3D one, can assume that the 2D version is just fine and not worry about being able to integrate out the mass!  That means I can move on to the next steps.</div><div><br/></div><div><br/></div><div>12/4/17</div><div><hr/><div>Finished coding up integrals for the phi terms, which are the Fourier transforms of the density profiles (basically):</div></div><div><img src="CMB%20HOD.resources/B41A5150-2B29-4C52-B184-05FE121FF30E.png" height="156" width="883"/><br/></div><div>So far only doing at z=1.  Have for many masses in the range log(M)=[11,17].</div><div><br/></div><div>See here for two different masses (10^11 and 10^16, solid and dashed respectively) and for the DM profile (white) and the galaxy number density (red) profiles:</div><div><img src="CMB%20HOD.resources/7A33C492-BD41-4BBB-94C7-A3B4A2E0F0FE.png" height="527" width="992"/><br/></div><div>(Note that the normalization surface density for the galaxies right now is arbitrary, just set at 10).</div><div><br/></div><div>Whether this is at all correct I don’t know, as none of the papers show this intermediate step. But it feels backward, as the value of phi decreases with increasing ell - suggesting that density is lower on smaller scales rather than vice versa.</div><div><br/></div><div>Integrating over the masses and comparing to my previous CMB lensing model (which is the 2-halo term; both here are normalized to 1 since my amplitude is currently arbitrary), where solid is 1 halo and dashed is 2:</div><div><img src="CMB%20HOD.resources/379E9796-38AC-46A7-9E68-FDA9806EAE47.png" height="535" width="982"/><br/></div><div>Seems to cover far too much dynamic range, and again is dropping with increasing ell, which seems backwards.</div><div><br/></div><div>In the units of Hill and Spergel (where they plot ell^2*(1+ell)*C_l), these at least go in different directions, but it seems backwards:</div><div><img src="CMB%20HOD.resources/72790768-47E7-4DD3-882D-F9A547965CB2.png" height="511" width="995"/><br/></div><div><br/></div><div>Compare to, e.g:</div><div><img src="CMB%20HOD.resources/7AF12759-6388-4859-B110-BF30C2006628.png" height="703" width="904"/><br/></div><div>Of course, the physics here is totally different.  Maybe I should try coding up the equations of Hill &amp; Spergel exactly (doing the SZ effect), and try to reproduce their plot…that would likely be informative.</div><div><br/></div><div>Before I do that, looking through the paper for any things I could have missed…and it seems weird to assume that the rho term in the FT integrals are projected, when the notation throughout is that rho is a 3D profile.  While it is weird that the integrand isn’t unitless this way, it does smooth all those wiggles out of the phi_ell plot:</div><div><img src="CMB%20HOD.resources/3940A47A-EEA4-4E55-9DEF-FEB02B4149CD.png" height="527" width="991"/><br/></div><div>I had assumed those were just due to the sine term, but maybe instead have to do with the inverse tanh terms in the projection?</div><div><br/></div><div><br/></div><div>Trying to reproduce the lensing-SZ xcorr model, need a few new things. One is r_200c, which is the radius at which density is 200 times critical (NOT the same as virial radius, because that has an evolving Delta_c term). That’s easy to get.  The other is the pressure profile P_e, which is from this reference:</div><div><a href="http://iopscience.iop.org/article/10.1088/0004-637X/758/2/75/pdf">http://iopscience.iop.org/article/10.1088/0004-637X/758/2/75/pdf</a></div><div><br/></div><div>Got the Pressure profile worked out (equations 10 and 11 from that paper, plus fit params in Table 1):</div><div><img src="CMB%20HOD.resources/6B7C43B4-F92E-428A-9E73-C81827644BFF.png" height="716" width="1230"/><br/></div><div>Looks like the right shape (peaks in right place too), but almost exactly a factor of 10 too large?</div><div><img src="CMB%20HOD.resources/5EF86110-47A0-45AC-ABC2-30ABBE185909.png" height="1084" width="1094"/><br/></div><div>Looks to me like this is because P_200 is almost exactly 0.1, which when divided provides that factor of 10.  But for now I’ll ignore it, as I’m just interested in the shapes (normalization of this is all going to be a mess!)</div><div><br/></div><div><br/></div><div>12/5/17</div><div><hr/><div>Ran this through the mass integral (again ignoring the z integral and using z=1), do not reproduce the shape in Hill &amp; Spergel:</div></div><div><img src="CMB%20HOD.resources/754DB9FF-B250-4E42-9434-518AFD15D35E.png" height="674" width="1200"/><br/></div><div><br/></div><div><img src="CMB%20HOD.resources/E1B20A1B-92EC-45FD-A584-E9B7234CF1BF.png" height="666" width="1252"/><br/></div><div><br/></div><div><br/></div><div>Part of the problem is that I don’t have an intuitive feel for what e.g. the NFW density profile should look like. I did find this:</div><div><img src="CMB%20HOD.resources/49ECAB90-D540-4E0C-8994-2F75FD9B6DDF.png" height="1260" width="1370"/><br/></div><div>(that’s k on the bottom, not ell, but I think k=ell/d_a</div><div>Not sure why those are so flat on large scales (small k), but a few things to notice:</div><div>1) They do fall with increasing k, which I though might be backwards </div><div>2) They have some wiggles, although they don’t seem to increase with mass like mine do.</div><div>Compared to my curves for a 10^13 (solid) and 10^15 (dashed) mass halos:</div><div><img src="CMB%20HOD.resources/182A6F6E-4A92-408E-BDBB-10DA1215D7B4.png" height="1032" width="848"/><br/></div><div>Mine don’t fall nearly as fast, and aren’t flat. Also, seems backward with mass compared to above.</div><div><br/></div><div><br/></div><div>12/13/17</div><div><hr/><div>Decided that to accurately compare to Hill &amp; Spergel, I needed to do integrals over M and z to see how much that matters.  In order to do that in any efficient way, need to build code to handle multiple dimensions at once, rather than looping over arrays of values. This took a considerable amount of time, but am mostly there. </div></div><div><br/></div><div>Now working on integral over r to calculate phi_ell - one issue I’m having is that for a well sampled r, even using array manipulation is a bit slow because of all the reshaping that needs to be done.  Trying to find a solution to this issue - I assume an interpolation would do it, but not sure how best to handle it.</div><div><br/></div><div><br/></div><div>12/15/17</div><div><hr/><div>One possibility to improve accuracy of integration (after chat with ryan) was to convert to integral over dlog(x) instead of dx. Shouldn’t be that difficult as dlogx = x*ln(10)dx</div></div><div><br/></div><div>However, I realized that I’m currently integrating much farther out in r than I need to - in Hill &amp; Spergel, only go to 1.5*rvir. For most halo masses, this is on the order of a Mpc or less, not 30. That means my gridding can be much more fine with same number of points.</div><div><br/></div><div>I’ve now modified my code to build a different range of x values for each pair of M and z, such that there are 1000 points, going out to 1.5*rvir and starting at a factor of 10,000 less than this.</div><div><br/></div><div>I good test now is to check the rho integral - does it give me back the input mass (using the total method of estimating the integral, not int_tabulated, since that doesn’t work in multiple dimensions)? If so, then to me that suggests the spacing is just fine.</div><div><br/></div><div>It appears that it does! For example, if I put in M=10^17 at z=8, I get back 1.003d17.  That’s plenty accurate. At 10^15 for z=3, get  1.0008d15.  Nice.</div><div><br/></div><div>But, there is a bug somewhere…when I put in multiple z and M, not getting back correct masses, and they’re more off for the second mass.  The issue is that because the r values are different now for every M,z combo, the steps are different, and I only have a 1-D difference between adjacent elements code. </div><div><br/></div><div>Not most efficient way, but wrote a diff_3d code to loop over z and logM dimensions and get diff(r) along each. Specific to this application for now, but will try to generalize it later if I have time.</div><div><br/></div><div>Working through generalizing code for SZ effect integrals…mostly done, but getting flat y_ell relationship...</div><div><br/></div><div><br/></div><div>12/18/17</div><div><hr/><div>Working on the r integrals more, and now get a pretty flat relationship out to high ell for both the phi and y terms:</div></div><div>y:</div><div><img src="CMB%20HOD.resources/71159354-321D-4C8A-A328-D1AFDA8CFF33.png" height="519" width="1020"/><br/></div><div><br/></div><div>For phi with the extra 1/(ell(ell+1)) term out front of the integral I get this:</div><div><img src="CMB%20HOD.resources/B884A84A-5294-4266-BE8D-46367F35BEC4.png" height="526" width="980"/><br/></div><div>But realized all that shape is due to the extra ell terms out front. Without those, it is very similar to y:</div><div><img src="CMB%20HOD.resources/840DE054-B873-472F-B85C-BA79485FF4BE.png" height="525" width="985"/><br/></div><div>Troubled by this at first, but I think it makes sense, on large scales (small ell), the one halo term has to become constant because you’ve gone outside the scale of the halo.  If I compare to a much higher mass (normalized to 1 for comparison of turnover), this is verified (solid is 10^11, dashed is 10^16):</div><div><img src="CMB%20HOD.resources/5D981639-C8B4-4F09-A656-7C7774707E5D.png" height="539" width="977"/><br/></div><div>The same holds true for the y term in the SZ effect.  </div><div><br/></div><div>Moving on!</div><div><br/></div><div>12/19/17</div><div><hr/><div>Working on the mass and z integrals now.  Passing full z array and full logm array eats way too much memory, so I do have to loop over one of them. Looping over z while passing all M ends up taking ~90 minutes to get the phi_ell and y_ell terms. Once it’s done, just save to a file and the reload.</div></div><div><br/></div><div>Checking mass integral now, to check the effects of my logm grid size.  If I integrate using total compared to int_tabulated, the integral over mass is consistent within &lt;1%.  However, I’m using spacing uniform in logm, and still using dN/dM (rather than dN/dlogM).  Tried converting to dlogM, and while the accuracy is just as good, the numbers are vastly different (by over 10 orders of magnitude because of the factor of M that gets multiplied in)…not sure if this is a big deal?</div><div><br/></div><div>Not getting consistent results for z integral though - and noticed an issue going all the way back to dNdm.  There’s a strange discontinuity in dndm at z~2 for all masses.</div><div><img src="CMB%20HOD.resources/AE611835-096A-4B92-9C27-C817FD4845EA.png" height="528" width="995"/><br/></div><div>Could easily see that making the integral estimate I’m using inaccurate.  Must be something with the power spectrum files being read in? Yep, it’s using the spectrum at z=10 there! Easy enough to fix - just stop z at 9.905 instead of 10.005 - can’t make much of a difference.  Then just edit the phi(M,z) and y(M,z) arrays I already made to remove the last element in the z direction.</div><div><br/></div><div>But even with that fixed, still don’t get agreement on the z integral.</div><div><br/></div><div>12/20/17</div><div><hr/><div>Did some work to interpolate onto a finer grid for integrals. For M integrals, this didn’t change much, which means that the original grid (0.1 in logM) was fine enough).  E.g. for one value of z and ell, got 9.1647d-13 with first grid, and 9.1678d-13 with more fine grid.  In both cases, estimate using total within &lt;1% of this.</div></div><div><br/></div><div>For z, re-binned into a uniform logarithmic scale, otherwise spacing was too course at low z to do a good interpolation to begin with. Once I did this, interpolating finer changed integral significantly, from (for one value of ell) 1.00428d-7 to 2.9105d-8.  In the former, using total to estimate integral did not agree, in the latter it does again to &lt;1%.  Going even finer does not change things very much.</div><div><br/></div><div>In the end though, doesn’t reproduce the result from the paper:</div><div><img src="CMB%20HOD.resources/42B019AB-E428-4EC2-BE90-3682B809854E.png" height="704" width="1246"/><br/></div><div><br/></div><div><br/></div><div>There are a few places with odd behavior, though they tend to fall at the highest masses and thus are heavily down weighted by the mass function, so I have a hard time believing they are the cause of the mismatch.</div><div><br/></div><div>But for example, looking at y vs M at low z and high L:</div><div><img src="CMB%20HOD.resources/A202C8C1-CB0A-4973-99CA-4AD4E7FDE779.png" height="362" width="604"/><br/></div><div>Some values go randomly negative above 10^15 (most but not all). Then, when interpolating this to finer M, this causes weird behavior above 10^15.  It’s also only present at very low z - once you get to z~0.2, things are nice and smooth for all ell.  This will also be seriously down weighted by the volume averaging in the z integral.</div><div><img src="CMB%20HOD.resources/83CB3595-0D8E-4F46-A83D-3896F45920F2.png" height="360" width="607"/><br/></div><div>Similar issues happen at low z/high M for phi as well:</div><div><img src="CMB%20HOD.resources/E1FC8AFB-1408-481E-AA5E-4731E8FC782C.png" height="358" width="609"/><br/></div><div><img src="CMB%20HOD.resources/3A3A1221-E2A6-4CE5-8511-04D609517AB8.png" height="359" width="613"/><br/></div><div><br/></div><div><br/></div><div>12/21/17</div><div><hr/><div>Trying to figure out the lack of turnover in ell…looking just at mass integral (before z integral, which is really just a weight by volume). Basically none of these at any z turn over with ell, though the lowest redshifts start to get close:</div></div><div><img src="CMB%20HOD.resources/2F9AAA20-1FC1-4281-B035-9570DB809211.png" height="378" width="720"/><br/></div><div>In linear space (on the y-axis, the low redshifts definitely start to get close to the right shape:</div><div><img src="CMB%20HOD.resources/FCCD22A2-28DD-4B06-BE00-295DEA23CEE1.png" height="380" width="727"/><br/></div><div>(what’s with the greek letters?)</div><div><br/></div><div>At low redshift, here is phi*y (*l^2(l+1)) for different masses - they basically all turn over:</div><div><img src="CMB%20HOD.resources/3411BF05-0E00-4BA9-9D57-82546BF6AD5A.png" height="526" width="1005"/><br/></div><div>At high z, they still turn over but at higher ell:</div><div><img src="CMB%20HOD.resources/9D92C687-8A35-4AA0-AA7F-089A385D84C1.png" height="532" width="987"/><br/></div><div><br/></div><div>And at low M, for all z, never turns over:</div><div><img src="CMB%20HOD.resources/04C5D145-3C79-4BE9-8A45-D5D96D9BCFC1.png" height="688" width="1272"/><br/></div><div>But for high M, turns over for all z (UPDATE- not all z, at higher z still increases with ell):</div><div><img src="CMB%20HOD.resources/8ECDD52A-E281-4932-9827-69E92B662C6A.png" height="682" width="1264"/><br/></div><div>So the problem seems to be the domination by low M sources - which, since the Hill &amp; Spergel paper go all the way down to M~10^5, very very heavily dominate the mass function.</div><div><br/></div><div><br/></div><div>12/22/17</div><div><hr/><div>So it seems that the only way to get a turnover in the final C_l relationship is to cut out all the low masses and high redshifts. Limiting to logM&gt;12 and z&lt;~1 I get:</div></div><div><img src="CMB%20HOD.resources/DC6D386A-C401-438D-ADD5-C8700FC961B5.png" height="521" width="1008"/><br/></div><div>(UPDATE - seems it’s the low masses that dominate this effect - using all z and only higher Ms get very similar curve).</div><div><br/></div><div>Maybe there’s something wrong with my l_s term, which is the multipole equivalent of the scale radius?</div><div><br/></div><div><br/></div><div>2/5/18</div><div><hr/><div>On Colin’s suggestion, trying to compare to some other plots in their paper. In particular, Fig 4 shows the one-halo term at a given ell versus z, for different mass limits:</div></div><div><br/></div><div><img src="CMB%20HOD.resources/D4294D3B-BAD4-408D-BA8F-12415496384D.png" height="278" width="375"/><br/></div><div>Mine does not look like that:</div><div><img src="CMB%20HOD.resources/2BD3A6DA-9962-4098-BACE-DC784B4B91C8.png" height="544" width="666"/><br/></div><div>The shape is off, and the dynamic range is way too high (I had to use a log y axis to even see anything).  </div><div><br/></div><div>They have similar plots for the autocorrelations of the lensing and SZ maps, which I can also check. Trying the lensing (C_l^{phi*phi}), at these ell values I just get 0s for everything. The Compton-y autocorrelation looks just like the cross-correlation, but much higher amplitude. So right now there seems to be something wrong with both terms, not just one! Great.</div><div><br/></div><div>2/6/18</div><div><hr/><div>Ryan pointed out that I still need to multiply everything by the d2v/dzd_omega integral, in order to just have dC/dz leftover.  That differential co-moving volume element has ~the inverse shape of the plots above, which might help get things closer.</div></div><div><br/></div><div>Unfortunately, still not the right answer:</div><div><img src="CMB%20HOD.resources/D60F2F4A-E660-4ECC-B40E-C7D24D06F85B.png" height="535" width="965"/><br/></div><div>At least reduces the dynamic range so there’s some consistency there, but not much else</div><div><br/></div><div><br/></div><div>2/7/18</div><div><hr/><div>With no obvious clue as to where my issues lie, have gone back to just detailed checking of every piece of code (of which there are many).</div></div><div><br/></div><div>Looking at my NFW profile code, am now comparing much more carefully to the original NFW plots. Namely:</div><div><img src="CMB%20HOD.resources/D78841AE-9B94-4558-B54D-1A6ED94B9B9F.png" height="366" width="734"/><br/></div><div>Where the x-axis is in kpc, and the y is in M_sun/kpc^3/10^10.</div><div><br/></div><div>The two masses shown are 0.01 and 100 times M*, where M* is fixed by sigma8=1.3 to be 4.1e13 M_sun/h.  I should note that this is *not* the value I get in my M* code (I get 3.09e12), despite getting reasonable agreement for this number with Zheng et al. 2007.  However, all it is used for is calculating the concentration index, which I pull from here instead of calculating using the Zheng equations:</div><div><img src="CMB%20HOD.resources/75014286-D39D-46B1-885F-3380C78C5A89.png" height="890" width="956"/><br/></div><div>At 10^11, it’s about 1.05, or log(11.2), and at 10^15 it’s about 0.7, or log(5).  (Note that using my code and my M* value I get about 14.6 and 4.4, which aren’t all that different).</div><div><br/></div><div>I’ve set up my cosmology the same as NFWs (omega_m=0.25, omega_l=0.75, h=0.75, sigma8=1.3), and for the low mass it looks decent, but the high mass is somewhat significantly off:</div><div><img src="CMB%20HOD.resources/050AE2A0-0CEC-45ED-B392-B8AD3375A738.png" height="734" width="858"/><br/></div><div>It should be at about R~0.8 along the top axis, and R~4 on the bottom axis.</div><div>Obviously, this difference isn’t big enough to cause the serious difference in my overall result from H&amp;S, but would be nice to understand.</div><div><br/></div><div><br/></div><div>2/8/18</div><div><hr/><div>If instead of using 100*Mstar, I use 10*Mstar (which is what they do for the non CDM models), I get this, which is really quite close to the NFW curves.  Since they don’t actually list the masses they plot, but rather just say something like “near the high and low mass ends,” this could be right. It would make more sense (to me) to have every panel plot similar masses, so I think I’m just going to assume that things are all good (or at least so close that it won’t make much difference in my end result)</div></div><div><img src="CMB%20HOD.resources/05CCF85B-1E1E-46C7-8AD6-B3C5313B3F7B.png" height="533" width="623"/><br/></div><div><br/></div><div><br/></div><div>2/12/18</div><div><hr/><div>Last check on the NFW profiles, just testing two masses at two redshifts using current cosmology, etc, rather than NFW values.</div></div><div><img src="CMB%20HOD.resources/1B043A9C-2EBF-4FD1-8D96-225DAACFF24A.png" height="631" width="710"/><br/></div><div>Integrating to r_vir gives back input masses for each. Checked explicitly the dependence of concentration index and viral radius on mass and z (based on original equations) and they are as expected. Looks good to me! </div><div><br/></div><div><br/></div><div>2/13/18</div><div><hr/><div>Now working on the SZ thermal pressure part. One issue that I found is that their fitting formulae are for the thermal pressure profile (P_th), while what I want is the electron pressure (P_e).  These are just related by a constant P_th = 1.932*P_e.  Updated code to return P_e instead of P_th.</div></div><div><br/></div><div>Realized I never resolved the issue that my pressure profile amplitudes were off by a factor of ~10, and while the shape is really what should matter started digging into this while I’m revisiting the code.</div><div><br/></div><div>Another issue is that I don’t seem to get the same viral radius as them, based on where it is marked on their plot (where it’s normalized by R_200). So there’s an issue with one or the other of those values, and it seems to me that it is most likely R_200.</div><div><br/></div><div>I think the way I was doing the conversion between different mass/radius definitions wasn’t right, so now writing code to do that. I *think* I should keep the same density profile calculated as it was (i.e. using an evolving Delta_cr based on spherical collapse, not just a broad-brush value of 200 or whatever), and then figure out what radius encloses the new Delta_cr value.</div><div><br/></div><div>To do this, need to step through r values, integrate the density profile to get the mass in that radius, and then use that to calculate the average density (M/V) until I get to the radius where this is rho_crit*Delta_cr.</div><div><br/></div><div>As a quick check, if I run my NFW profile code with delta_cr set to 200, and then try to calculate M_200 from that profile, I get back the same value, which is good.</div><div><br/></div><div>Converting from M_vir to M_200 get typical ratios around 1.2:</div><div><img src="CMB%20HOD.resources/8652004F-ECC0-489E-8A6F-B5A1179B4381.png" height="528" width="979"/><br/></div><div>According to <a href="https://arxiv.org/pdf/astro-ph/0412161.pdf">https://arxiv.org/pdf/astro-ph/0412161.pdf</a> it should be more like 1.7 though. I’m not sure if I’m doing something wrong or if that factor is a difference in assumptions elsewhere.</div><div><br/></div><div>After adjusting this conversion, I get a ratio of R_vir/R_200 of ~1.35, which looks roughly right (difficult to tell on the Battaglia plots since they don’t have minor axis ticks, but it’s about halfway to 2 with in log is about 1.3ish).</div><div><br/></div><div>Checking M_500 though, I get M_500/M_200~0.66, which looks quite close on their plot. </div><div><br/></div><div>I also did this conversion using Appendix C of <a href="https://arxiv.org/pdf/astro-ph/0203169.pdf">https://arxiv.org/pdf/astro-ph/0203169.pdf</a>, and got *very* similar results.  Also note that these ratios are very consistent with figure 11 here: <a href="https://arxiv.org/pdf/1005.0411.pdf">https://arxiv.org/pdf/1005.0411.pdf</a> (note that my Delta_c for viral values at z=0 is ~100, with a c_200 of ~10, in order to tell which lines to compare to).</div><div><br/></div><div>So this all seems like it’s just fine, and will use the analytic prescription moving forward (much faster).  But that doesn’t help sort out what’s wrong with my SZ pressure profile.</div><div><br/></div><div><br/></div><div><br/></div><div>2/19/18</div><div><hr/><div>Well, I’ve been real dumb about the amplitude of the pressure profiles.  The fits provided by Battaglia are fits to the normalized profile, so the factor of P_200 is already included, I don’t need to divide by it! However, to get back P_e for the actual model I’m doing, I will need to multiply it back *out*, so need to build it into my SZ effect code, so that it is returned in physical units (M_sun/(Mpc*s^2)).</div></div><div><br/></div><div>And after digitizing the appropriate curves, and setting my masses such that they give M_200 values in the middle of the fit ranges from Battaglia, I’d say I’m doing pretty well:</div><div><br/></div><div><img src="CMB%20HOD.resources/76452BAB-06D2-48BB-A937-A1C13B680C98.png" height="541" width="986"/><br/></div><div>I’ve been obsessing over these curves for a week and they were (basically) right all along…</div><div><br/></div><div>Checking the higher z panel as well, to be sure:</div><div><img src="CMB%20HOD.resources/59AD8419-3312-46E6-91D7-2CBD675AE098.png" height="534" width="993"/><br/></div><div>Looking good!</div><div><br/></div><div>Rather than comparing to Battaglia, just look at actual pressure profiles vs. mass and z:</div><div><img src="CMB%20HOD.resources/5327DF0B-C493-4C94-97C7-3692672C1737.png" height="382" width="709"/><br/></div><div>Looks reasonable! Also note the amplitude on the y-axis - now that I handle P_200 appropriately (i.e. not using the normalized profiles), the amplitude of things should drop considerably, which is good considering my overall amplitudes earlier were way too high.</div><div><br/></div><div>Colin mentioned that the SZ effect scales with mass as ~ M^(5/3).  Not exactly sure what he means by this, as can be interpreted different ways.  Is that the integrated pressure out to some r scales with M that way? Or the pressure at some particular R? Or something else?</div><div><br/></div><div>In either case (using r_200 as the limit) I get a nice power law between logP and logM, but with a slope of 1.1 and 0.6 respectively...</div><div><br/></div><div>Finally on the the actual hard part with the integrals…</div><div><br/></div><div>Starting with phi_y term.  Note the tiny dynamic range on the y-axis (this is for very low mass, logm=6):</div><div><img src="CMB%20HOD.resources/28738300-B4EB-4FC9-95D1-087BFD7EB717.png" height="545" width="836"/><br/></div><div>Higher masses have similarly small ranges, but higher amplitudes.</div><div><br/></div><div>Thinking more about where the flat part is here, expect it to be on scales larger than the halo. If r_s ~ d_A/ell though, this isn’t right. Since the characteristic angular scale is d_A/r_s though, I think this should be right.  </div><div><br/></div><div>But l_s is typically at ell a few orders of magnitude more than where this relationship turns over.  E.g. for M~10^6, l_s ~ 1d6, because the scale radius r_s (or r_200) is so small (0.001 Mpc/h here).</div><div><br/></div><div><br/></div><div>2/20/18</div><div><hr/><div>Checking my simple integration method (collapsing along rows with total) in the y_ell integral. Compared to int_tabulated, get very similar results.  For logm=6, z=1, ell=1 within 1d-3.  Similar (but slightly worse) at high mass (10^16).  At higher ell it starts to get near 1% accuracy, which still is quite good.  Similar accuracy at high redshift (10.)</div></div><div><br/></div><div>My phi_ell integrals have similar accuracy. So the way i’m doing the integral isn’t an issue, of course this test is useless if the way I’m setting them up is wrong.  Also confirm that I get the same answer back whether I pass it one or several masses, to verify that something funky isn’t going on in the reshaping of the data hyper-cubes</div><div><br/></div><div>Looking at plots of the phi_l curves, noticing lots of bumps and wiggles and far less dynamic range than what I was seeing before:</div><div><img src="CMB%20HOD.resources/81983DF4-7E82-4E02-AE53-E1C2A752B566.png" height="534" width="997"/><br/></div><div>Not sure why this is, as not really much changed in my NFW density code, which is what this depends on?</div><div><br/></div><div>Also, in another test I just divided r_s by 1e6…and this doesn’t change the final result at all.  Which seems impossible? Oh…it gets canceled when you take x/l_s.</div><div><br/></div><div>If instead I increase l_s, things get super noisy:</div><div><img src="CMB%20HOD.resources/4FA79021-5DA2-45D2-8F26-31E151F87F4B.png" height="506" width="973"/><br/></div><div>Conversely, decreasing it makes all those wiggles go away (and changes the amplitude).  But doesn’t actually change where the turnover occurs.</div><div><br/></div><div>In any case, ran through the whole thing to see what the final answer is, and at least looking better! Still not right though:</div><div><img src="CMB%20HOD.resources/0DDF2D32-3D85-409F-9DAC-E9D432FDDF5F.png" height="536" width="966"/><br/></div><div>My amplitude is now far too *low* (this plot above is multiplied by 1d29, in the paper that show order of 1d11).  Also peaks at too low of ell (by order of magnitude). But the dynamic range is closer to what I expect (factor of a few), and at least it has a peak.</div><div><br/></div><div><br/></div><div>2/21/18</div><div><hr/><div>So it seems that a lot of that shape above is because the amplitudes of phi_l and y_l are so low that when you multiply them together a lot of terms turn up as 0, especially at large ell. So that causes that turnover, not something real.</div></div><div><br/></div><div>If you multiply phi and y by a large constant so that when you multiply them together you don’t have numerical issues, the final curve looks like:</div><div><img src="CMB%20HOD.resources/8DD568A0-9D9E-407E-A276-A09562288C3D.png" height="530" width="1002"/><br/></div><div><br/></div><div><br/></div><div>Oh! Progress! Remaking the plot of dC/dz at l=1000 for different mass integral ranges, I get similar behavior as H&amp;S (note that I had to multiply both phi and y by a constant factor of 6.2d8 to get this):</div><div><img src="CMB%20HOD.resources/577736ED-1848-4A30-A774-C15481E10471.png" height="526" width="682"/><img src="CMB%20HOD.resources/5B0B0F3A-E442-42AF-A871-D03DD6B0988F.png" height="327" width="463"/><br/></div><div>The peak is in the right place (around z~0.3).  Amplitudes are a little off - 2 orders of magnitude for sure, and then a factor of 2 or 3 (mine range from 0 to 4ish, theirs from 0 to 1.6ish).  And the mass and z dependence isn’t quite as strong. But some features, like the bump that starts to show up around z~0.1 for lower masses is there, so I feel like I’m getting close!</div><div><br/></div><div>Thought maybe if my ell dependence was wrong, would better match their figures at slightly different ells.  But if I make the same plots at ell=900 or 1100 it shifts the peaks to higher or lower redshifts (and changes amplitudes of course).</div><div><br/></div><div><br/></div><div>For the yy autocorrelation, need to multiply the y_ell term by 6d7 to get the right amplitude for the high mass bin. Seems that the mass and z dependencies here aren’t quite right, and maybe not quite ell either (peak is slightly too high z for this ell) </div><div><img src="CMB%20HOD.resources/DE9A31D3-FDE3-4EFB-8DED-95E15F699579.png" height="390" width="516"/><img src="CMB%20HOD.resources/F02535F6-1772-456A-B5B0-99C014B7E267.png" height="890" width="1026"/>   </div><div><br/></div><div>And the phi phi autocorrelation is way off! So this is at least a promising place to start trying to fix…</div><div><img src="CMB%20HOD.resources/44458CBC-2027-48C5-9CF6-81A8DB3744A4.png" height="388" width="534"/>  <img src="CMB%20HOD.resources/E11DBC3F-9ABE-4A51-AB49-50B7A8CCE0BD.png" height="862" width="1038"/><br/></div><div>The rise with z here though at least somewhat explains the too-slow decrease with z in the cross-correlation (though it’s present in the y-y cross correlation too so there’s still an issue elsewhere).</div><div><br/></div><div><br/></div><div>2/22/18</div><div><hr/><div>A bit strange that the phi integral is wrong but the y is close. I know my NFW profile is right, and otherwise the steps are identical, so what’s up?</div></div><div><br/></div><div>The thing that the phi term has that y doesn’t is the normalization by Sigma_crit. And lo and behold there’s a bug there! To save computing time (which is actually unneeded now that I made things handle all M and z simultaneously) I was passing the sigma_crit code distances instead of z values. But there’s a factor of 1+z in the equation (although that only shows up in H&amp;S, not in the definition of critical surface density on e.g. wikipedia…), so that gets screwed up.  It’s not immediately clear that this is the cause of other issues, but certainly a problem.  Fixed and re-running now…</div><div><br/></div><div>Ok, the phi phi autocorrelation is definitely looking better, but still not quite there:</div><div><img src="CMB%20HOD.resources/87C7443D-664A-4893-9781-AAE224F7869F.png" height="515" width="695"/><br/></div><div>M dependence not strong enough, and peaks at too high of z (they do turn over if I plot at higher z, but peak at ~4…after that behavior is similar in that all masses converge at higher z, peak shifts to higher z with lower masses, etc.).</div><div><br/></div><div>The final plot is starting to look like it has the right shape as well, but peaks at too high of ell beyond my limit of 10^4…but is definitely better than before.</div><div><br/></div><div>There’s also the issue that I’m not including the two halo term, which H&amp;S figures do by default…but at these scales the one halo term does dominate (by about a factor 3 however, so not a crazy amount).</div><div><br/></div><div>Note also that the cross-corr plot now doesn’t peak in the right place, because of the increased contribution on the wrong scales here for phi now:</div><div><img src="CMB%20HOD.resources/89722890-B7F7-4D0A-A59F-2E6FFEFF7CF5.png" height="714" width="1196"/><br/></div><div><br/></div><div><br/></div><div>2/23/18</div><div><hr/><div>Given the incorrect redshift dependence, started wondering about the factor of (1+z)^3 in the critical density that I took out, since this is a strong z dependence that could down-weight higher z.  This is in fact the case, and I get better (but still incorrect) z dependence including this anywhere rho_crit shows up.</div></div><div><br/></div><div>For the phi-phi autocorrelation, definitely peaks at lower z now (around 2-3, instead of 4 before):</div><div><img src="CMB%20HOD.resources/771D7A5F-4C2D-4444-9A26-675F08341C27.png" height="535" width="979"/><br/></div><div>Mass dependence not strong enough still.</div><div><br/></div><div>y-y definitely has steeper z dependence, but not quite as strong as it should be yet. Same M issue as above:</div><div><img src="CMB%20HOD.resources/519875A1-6FBB-4E07-9DF2-447293F46020.png" height="539" width="711"/><br/></div><div>The cross correlation still peaks at too high of z now, because of the phi term being too high in z I’m sure.</div><div><br/></div><div>All that said though, I’m finally starting to get something close to the right shape for the final result!</div><div><img src="CMB%20HOD.resources/0FD9EAA5-2FCC-4A53-95A4-0C3A5DCE2318.png" height="530" width="721"/><br/></div><div>Peaks at slightly too high ell (3000 instead of 2000), and the dynamic range is about 2 times too large. But that is probably because my M and z dependencies aren’t right - the signal from low masses and high zs is too high, and these are the values that get weighted more strongly in both cases.  But what else to tweak??</div><div><br/></div><div><br/></div><div><br/></div><div>2/26/18</div><div><hr/><div>All of these figures now with direct comparison to digitized versions of the H&amp;S plots, for easier checks:</div></div><div>(Note all amplitudes are scaled by arbitrary factors to match peaks of H&amp;S values currently:)</div><div><img src="CMB%20HOD.resources/51B93AC5-B4F8-4E22-B3CA-19C257D4B4B8.png" height="537" width="983"/><br/></div><div>In this case, a potential clue might be that if I just divide ell by 1.7, we get quite good agreement…:</div><div><img src="CMB%20HOD.resources/CBA7ECA9-451E-4A33-BB56-42C2B2CAB964.png" height="526" width="980"/><br/></div><div><br/></div><div>M and z dependence of phi*y:</div><div><img src="CMB%20HOD.resources/7EFBCFF3-86E5-4409-86D1-0CF0D3B93971.png" height="540" width="978"/><br/></div><div>y*y:</div><div><img src="CMB%20HOD.resources/0ED83600-BA8B-4B92-A3EF-1EFE58AD4882.png" height="537" width="985"/><br/></div><div>phi*phi:</div><div><img src="CMB%20HOD.resources/8650DBF6-2FD9-4150-AE57-9FA2080534B6.png" height="534" width="979"/><br/></div><div><br/></div><div>In careful checks of the code, maybe some more issues with sigma_crit_lens, due to potential typos in Hill &amp; Spergel.  For 1, distances for this should be angular diameter distances, not comoving distances.  In addition, in looking for explanation of the (1+z) term which isn’t e.g. on the wikipedia page, realized it’s because the distance between the source and the lens is not just the difference between the two distances.  Rather it’s (<a href="https://ned.ipac.caltech.edu/level5/Hogg/Hogg6.html">https://ned.ipac.caltech.edu/level5/Hogg/Hogg6.html</a>):</div><div><img src="CMB%20HOD.resources/68465BE6-7D42-4951-BDB9-2A327DC27C57.png" height="87" width="461"/><br/></div><div>Here though, D_M2 and D_M1 are comoving distances.  So there are several issues with Hill and Spergel’s equation:</div><div><img src="CMB%20HOD.resources/B52AAB2A-7CC6-48A3-9C48-6645B2A53FF0.png" height="70" width="314"/><br/></div><div>The first Chi values outside the parentheses should be angular diameter distances (and so have different symbols), while those where the difference is taken should be comoving, as labeled.  Also, it seems to me that the factor if (1+z) should be (1+z*), where z* is the redshift of the CMB.  In the equation above, z2 is the redshift of the farther source (if 2 was not farther than 1, then the distance difference would be negative).  </div><div><br/></div><div>But, on direct comparison, it turns out that all of that is equivalent! Interesting…I guess it’s because comoving and angular distance are related by factor of (1+z)…so in converting comoving distances to angular, you get a factor of (1+z*) and (1+z), but then the 1+z* one cancels out because it’s also in the equation for the distance between the two.</div><div><br/></div><div><br/></div><div><br/></div><div>A closer look at the interpolation I’m doing to do the integrals and how much that impacts things.  There are subtle differences between them.  For example, on the high mass end of the halo mass function interpolation:</div><div><img src="CMB%20HOD.resources/2D5FF119-CE42-4ED0-92AD-8DF62F001F21.png" height="738" width="1230"/><br/></div><div>Using a spline (yellow), polynomial (magenta) and linear interpolation (red).  Doesn’t look like much, but changes the value (at z=0, l=100)  of the integral by up to 3%. However, do notice that with the regular spline (yellow), integrating the un-interpolated and interpolated ones with int_tabulated (most accurate) gives same answer (within &lt;1%). My integrator gives that answer for the interpolated version, but is off by factor of ~1.5 for the un-interpolated.  Is it safe to assume that int_tabulated gives the “right” answer? </div><div><br/></div><div>Found that int_tabulated uses a fancy interpolation scheme (5th-order Newton-Coates formulas, <a href="http://mathworld.wolfram.com/Newton-CotesFormulas.html">http://mathworld.wolfram.com/Newton-CotesFormulas.html</a>), so I think it’s ok to just use this. Only reason I’m interpolating is so that my simpler method gives similar answer.</div><div><br/></div><div>Checked at several z and ell, and always within &lt;1% of the un-interpolated int_tabulated result. </div><div><br/></div><div>On closer inspection, after fixing a bug it seems that using my simple integrator gives closer to the un-interpolated int_tabulated answer. The interpolated one is still accurate to &lt;1%, but may be unnecessary if my metric is this one.</div><div><br/></div><div><br/></div><div>2/27/18</div><div><hr/><div>Tried finding a way to formally compare my sigma_crit values, and did find this figure here <a href="https://arxiv.org/pdf/0910.1361.pdf">https://arxiv.org/pdf/0910.1361.pdf</a>:</div></div><div><img src="CMB%20HOD.resources/E569BDAE-1A82-49C1-B73B-57592721334B.png" height="578" width="790"/><br/></div><div>Putting the source redshift as my CMB redshift, and the lens redshift as my objects, I get a qualitatively similar answer:</div><div><img src="CMB%20HOD.resources/2486BC79-B851-48CF-BE9A-C839009549A1.png" height="714" width="1212"/><br/></div><div>Doesn’t drop as fast, but the shapes and general trends are the same. Our cosmologies are very similar (they use Komatsu et al. as well, but a different column of the combined results, though these are very minor differences). Is a little worrying, since e.g. the z_lens of 0.8 isn’t dropping as fast as it should, and maybe this is an issue with my z-dependence?</div><div><br/></div><div>Huh - it seems that this paper I’m comparing to has an extra factor of 1+z in their Sigma_crit equation?</div><div><img src="CMB%20HOD.resources/366A54AC-36FF-48B9-859E-B86E7EEBDB9C.png" height="168" width="1016"/><br/></div><div>I have verified that the H&amp;S equation agrees with many other sources (wikipedia and basically every set of slides I see online), and it does not have this factor of 1+z in it:</div><div><img src="CMB%20HOD.resources/IMG_5019.jpg" height="3024" width="4032"/><br/></div><div>If I divide out this 1+z, my plot is closer to theirs, but still not identical:</div><div><img src="CMB%20HOD.resources/7B8A54C5-83F9-4457-9377-98A340390865.png" height="724" width="1224"/><br/></div><div>And actually, if I put in the angular diameter distance (my equation uses comoving) which is what their equations say, the agreement is far worse. I don’t know what the hell these guys are doing…</div><div><br/></div><div>Since that seems wrong, tried comparing to here <a href="http://inspirehep.net/record/846451/plots">http://inspirehep.net/record/846451/plots</a></div><div><img src="CMB%20HOD.resources/F050AE0F-8C6D-41A7-A113-C21A9492141A.png" height="904" width="1394"/><br/></div><div>Which is in inverse critical density, and has the lens redshift on the x-axis and life styles for the source redshift (opposite of above).  But I can make this plot as well, and here I get great agreement:</div><div><img src="CMB%20HOD.resources/FBD90AA6-E156-473B-ABB8-D419DE42255C.png" height="714" width="1218"/><br/></div><div><br/></div><div><br/></div><div>2/28/18</div><div><hr/><div>After fixing dV/dz (I had forgot to divide by dz when I was doing it before, now just using the equation <a href="https://ned.ipac.caltech.edu/level5/Hogg/Hogg9.html">https://ned.ipac.caltech.edu/level5/Hogg/Hogg9.html</a></div></div><div><img src="CMB%20HOD.resources/26106989-A160-4E2F-92B0-31D161F5EA2E.png" height="114" width="512"/><br/></div><div>Get something a bit closer for yy:</div><div><img src="CMB%20HOD.resources/3D2D2AB7-EC2B-4323-B723-6F3505FB6A74.png" height="347" width="604"/><br/></div><div>and ph*phi:</div><div><img src="CMB%20HOD.resources/0B529685-D93E-47ED-8D35-38A588AD762D.png" height="720" width="1208"/><br/></div><div><br/></div><div>However, in thinking about other issues it seems that for the y*y term everything must be right, and maybe the HMF integral is actually wrong.  For 1, I was using Tinker 2010, and the H&amp;S paper uses Tinker 2008. Not a huge difference, but is a factor of a few or more especially at high mass that could contribute a lot.</div><div><br/></div><div>But more importantly I have dN/dM, but my delta(x) values in the integral are dlogM.  I need to fix that as well.</div><div><br/></div><div>Turns out that with this fix, my mass dependence looks much better! Also I’m only off by a factor of about 3.02 now in amplitude! That’s pretty damn close. But still an issue in z:</div><div><img src="CMB%20HOD.resources/80C8364A-249A-4C16-925C-28E2632613F5.png" height="706" width="1194"/><br/></div><div>Unfortunately, phi*phi looks worse, as now I’m way too steep in z (but the amplitude here is now right to within 1.56, which again is pretty good, and the mass dependence looks better):</div><div><img src="CMB%20HOD.resources/EEA0448A-2F2D-4F8F-B519-61FFE3E0758A.png" height="712" width="1194"/><br/></div><div><br/></div><div><img src="CMB%20HOD.resources/115605BD-1F9D-4C31-844D-3D87B4906E34.png" height="710" width="1176"/><br/></div><div>This is only off by a factor of ~2 now (note that I have to multiply the phi and y terms by a few orders of magnitude first, rather than as a final factor, or somewhere along the way the values get so small they go to 0 in the code. But progotating those through I’m off by this factor of 2 only).</div><div><br/></div><div>3/1/18</div><div><hr/><div>Now checking accuracy of M integral by looking at changing variable to dlogM.</div></div><div><img src="CMB%20HOD.resources/AB64B35D-779E-441B-AE87-75DB641AE844.png" height="82" width="1210"/><br/></div><div>These should be equivalent.  So if I use int_tabulated on these, with the x variable as 10^logm and logm, and the HMF in the proper units, do I get the same thing?</div><div><br/></div><div>Here it is with 100 values of logM (5-14.9):</div><div><img src="CMB%20HOD.resources/4073AAE6-ACC0-4AF0-9293-0D8068BDF79C.png" height="465" width="620"/><br/></div><div>In linear: 1.271e10</div><div>In log: 8.388e10</div><div><br/></div><div>And with 991 values (5-14.9)</div><div>Linear: 1.281e9</div><div>Log: 8.388e10</div><div>Why is it suddenly an order of magnitude smaller in linear space? Basically identical in log.</div><div><br/></div><div>And with 9991 values (5-14.9)</div><div>Linear: 1.56e8</div><div>8.388e10</div><div>Why does the linear one drop like that? I’m confused. If I check for example the full M integral that I’ve been doing, I get similar answers from int_tabulated for both the original M sampling and the interpolated one.</div><div><br/></div><div>In addition, if I do the integral using diff and total, for the log one I get the same answer, for the linear one it is many orders of magnitude smaller (10^3 instead of 10^10.) In addition, if I increase the number of points, the diff+total method stays similar OoM, while the int_tabulated drops.  I’ve been messing with this ALL DAY WHAT IS HAPPENING.</div><div><br/></div><div><br/></div><div>Ugh, stupid mistake. The extra factor of M*ln(10) doesn’t get included because the dlogM terms in the integral technically cancel (or rather, if you make the change of variables for both of them, these factors cancel.  This is why these integrals are messed up, and why if I include them in the actual model code the amplitudes are all off again.</div><div><br/></div><div>That said, switching to log space does increase the accuracy of the integral for a given grid spacing.  Using ~100 points in log(M):</div><div> <img src="CMB%20HOD.resources/F771E87C-63E3-4E21-85FC-7441A91A1327.png" height="142" width="664"/><br/></div><div>(as for why int_tabulated in linear space is so bad, I’m not sure…)</div><div>Going to ~1000 points:</div><div><img src="CMB%20HOD.resources/651AA635-F021-4527-9D98-0B66A563E02A.png" height="142" width="658"/><br/></div><div>Int_tabulated in log space is staying constant, and other methods converging towards it (though int_tab in linear space still way off)</div><div>And with 10,000 points:</div><div><img src="CMB%20HOD.resources/85498535-1FC3-46EB-BE04-2CE0242D2212.png" height="136" width="630"/><br/></div><div>Finally with 100,000 points:</div><div><img src="CMB%20HOD.resources/B4936F52-DEEB-417E-A7D1-6000FEB58F37.png" height="140" width="634"/><br/></div><div><br/></div><div>Checking the actual mass integral in the cross-correlation using integrals in logM and M…</div><div>Linear:</div><div><img src="CMB%20HOD.resources/291B65AA-4D80-42F0-BCD0-6A502DA26C70.png" height="144" width="656"/><br/></div><div>Why int_tabulated does a fine job here in linear space I’m not sure. Seems strange.</div><div>In log space:</div><div><img src="CMB%20HOD.resources/AF7F4131-0C19-4ED6-87A6-5D4B4428B8AE.png" height="148" width="668"/><br/></div><div>It does marginally better (assuming interpolated int_tab is the truth) but by a very small amount.</div><div><br/></div><div><br/></div><div><br/></div><div>3/4/18</div><div><hr/><div>Things to do:</div></div><div><span style="text-decoration: line-through;">1. Write code to convert from halo masses defined for mean vs. critical density.</span></div><div><span style="text-decoration: line-through;">2. Re-calculate HMF for model using appropriate mass definition (convert my virial mass to 200*mean matter)</span></div><div>3. Check that integral over b(nu)*f(nu) in Tinker 2010 HMF gives 1 (checking value of alpha) </div><div><br/></div><div>So once again the halo mass definitions come into play here - my HMF, from Tinker et al. (2010), using a mass definition of 200*rho_matter, while the masses everywhere else that I’m using are virial masses. Since rho_matter=Omega_m*rho_crit, can calculate what Delta is needed for the mass function is needed in order for these to be the same mass (and radius - can I just assume that the radius and mass scale in the same way? Need to think about that…).  This way, the mass and radii cancel, and just left with Delta_c = Delta_m*Omega_m.  So, need to use a different value of Delta depending on redshift.  This function looks like:</div><div><img src="CMB%20HOD.resources/3EF2BAD3-3280-407F-BF2C-15E0E4012E91.png" height="724" width="1176"/><br/></div><div>At high z they’re the same, at low z can be quite different.</div><div><br/></div><div>So, propagating this through, now for the 1-halo term my mass dependence looks bang-on! E.g., y-y autocorrelation:</div><div><img src="CMB%20HOD.resources/D0D3874A-ABFA-4898-A14C-B41C9237E0A9.png" height="706" width="1182"/><br/></div><div><br/></div><div><br/></div><div>3/5/18</div><div><hr/><div>Since Figures 3 and 4 in H&amp;S are not just the two and one-halo terms, respectively, but rather both at ell values where one dominates over the other, figured I might as well code up the two-halo term as well so everything is a direct comparison. Not to mention, at ell=1000 in figure 1, the two halo term is only a factor of ~3 less than the one halo, and I’m off by a similar factor (and it could have a different z dependence that helps with that discrepancy).</div></div><div><img src="CMB%20HOD.resources/933C8839-A0B2-4A9C-B23B-AD233D89A02D.png" height="75" width="898"/><br/></div><div>Basically have all these pieces, just need to generate the bias arrays from my bias2mhalo codes.</div><div><br/></div><div>Also need to get the linear power spectra in ell instead of k (k=ell/d_c).  For lower redshifts, mine don’t go to ell=10,000 because of the truncation in CAMB. But, on these scales it’s just a straight line in log-log space, so I just fit a line to the highest 100 ell values, and use this fit to generate points out to where I need. </div><div><br/></div><div>Realized in doing this that my bias code is missing the redshift evolution terms (eqs. 9-12 of Tinker 2010)! So…some of my published results are slightly off because they’re at z=1, but the z dependence isn’t that strong and the relative comparison is still the same.</div><div><br/></div><div>Including the Delta evolution so that masses are properly compared between different pieces, my two-halo term is pretty wrong, compared to H&amp;S fig 3. E.g., for y-y autocorrelation:</div><div><br/></div><div><img src="CMB%20HOD.resources/DD99230F-67D6-4FF6-ACEF-C767CE25048A.png" height="498" width="608"/><img src="CMB%20HOD.resources/620D71FB-50F7-4F64-8E04-3FFD51C8B118.png" height="230" width="293"/><br/></div><div>Since the one-halo version is very close, it seems that this must be an issue in the bias term? Or the power spectrum, but I think those are right as it’s just a simple interpolation.</div><div><br/></div><div>One thing that is mentioned throughout H&amp;S and highlighted in Tinker 2010 is that their formalism forces a normalization such that the mean bias over all masses is 1.  This is expressed in Tinker 2010 equation 7:</div><div><img src="CMB%20HOD.resources/DEF0FD32-A042-4D89-926D-10AF4146CFA1.png" height="65" width="357"/><br/></div><div>where f(nu) is the mass function.  This constraint sets the normalization of the HMF, given as alpha in their equation 8.  </div><div><br/></div><div>I modified my code to give back things in terms of nu to check this. It seems to me that this integral is never actually 1, and also varies with redshift. At z~0, this integral is ~0.72.</div><div><br/></div><div><br/></div><div>3/6/18</div><div><hr/><div>Updated codes to be a bit more flexible with plotting what I want to check, and digitized the ell=100 H&amp;S plots. Also made my dC/dz plots include both 1 and 2 halo terms.  Slight arbitrary scale factors still needed, but here is where we are:</div></div><div><img src="CMB%20HOD.resources/3B08A0A2-A588-4951-BE93-3F7E3D9A6AE4.png" height="516" width="605"/><img src="CMB%20HOD.resources/022553AA-66D2-4888-99D7-68EF5DDEEA45.png" height="507" width="615"/><br/></div><div><img src="CMB%20HOD.resources/B81EDA03-12AD-4684-BD1B-B13B6DBF2F9D.png" height="518" width="602"/><img src="CMB%20HOD.resources/F1A2D538-2316-421C-A89B-91BE2481CE1D.png" height="519" width="611"/><br/></div><div><img src="CMB%20HOD.resources/9DF72D1F-319F-43A6-B6D0-B4BAD14189BD.png" height="515" width="609"/><img src="CMB%20HOD.resources/9EFA57F9-AE17-42FD-925E-F9CBB1D48C8D.png" height="520" width="614"/><br/></div><div><br/></div><div><br/></div><div>For yy, dividing my result by H&amp;S (ell=1000):</div><div><img src="CMB%20HOD.resources/CEB29320-C01E-46C3-B8B6-5D8A59BB56F1.png" height="510" width="960"/><br/></div><div>Not an obvious factor of (1+z) missing anywhere. (No factors of (1+z)^x make this flat)</div><div><br/></div><div>Re-normalized to peak at 1 (easier to compare to other correlations):</div><div>yy</div><div><img src="CMB%20HOD.resources/F61C1FEB-4BE2-4A34-B3A3-384C12037874.png" height="518" width="950"/><br/></div><div>Phi-phi:</div><div><img src="CMB%20HOD.resources/9964D91B-9F26-42C8-BABB-167BA6DECE69.png" height="519" width="943"/><br/></div><div>Cross:</div><div><img src="CMB%20HOD.resources/709C2421-5A99-47A0-ABF0-CB939CCD0C1F.png" height="509" width="940"/><br/></div><div>These are all very similar - maybe slightly steeper in the phi-phi and cross? Hard to say exactly how much of the difference is just error in digitizing the plots vs. real.</div><div><br/></div><div>At ell=100</div><div>y-y</div><div><img src="CMB%20HOD.resources/3566FB47-DD6D-45B0-B04C-ACCE3F0CC278.png" height="516" width="944"/><br/></div><div>phi-phi</div><div><img src="CMB%20HOD.resources/7D8C4E2C-1207-4568-8189-C4D55C0478A5.png" height="517" width="944"/><br/></div><div>cross:</div><div><img src="CMB%20HOD.resources/7764F956-B860-4E69-8069-E0F59CFBC7ED.png" height="511" width="941"/><br/></div><div>One thing that stands out is that all the bumps and wiggles in the ell=100 plots are nice and smooth in the ratios, so those are at the right redshifts.</div><div><br/></div><div><br/></div><div>3/7/18</div><div><hr/><div>For the y-y autocorrelation, plotted in log-log you can see a pretty clear power law in the right units:</div></div><div><img src="CMB%20HOD.resources/CA3B6FA5-F071-4426-84FD-96621A5FCC45.png" height="525" width="971"/><br/></div><div>That dashed line is a power law with index (1+z)^(-3/2)</div><div>log(1+z)=0.4 is about 1.5, which is where the autocorrelation goes basically to 0, so above that is just noise probably.</div><div><br/></div><div>For ell=100 though not the same, it’s more like (1+z)^(-2) at least at low z:</div><div><img src="CMB%20HOD.resources/EDCC936F-6269-4B53-9B46-D3706D930902.png" height="539" width="986"/><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div>For the phi-phi auto-correlation (ell=1000), it’s a factor of (1+z)^(5/2):</div><div><img src="CMB%20HOD.resources/20DE0964-1DB8-44D1-B49F-BF23887FCE3D.png" height="526" width="987"/><br/></div><div>However, now the model doesn’t go to 0 at z=1.5, so why does it start to deviate there?</div><div><br/></div><div>But for the phi-phi at ell=100, not so simple:</div><div><img src="CMB%20HOD.resources/D3150F73-A146-4A94-A469-C55AB046F422.png" height="527" width="980"/><br/></div><div><br/></div><div><br/></div><div>For the cross at ell=1000, needs an additional offset of -0.1, with a slope of -2:</div><div><img src="CMB%20HOD.resources/36DD1A1A-F5D6-4FD3-A8DE-F5C77EBD2F05.png" height="539" width="992"/><br/></div><div>And then of course in the cross at ell=100, not so simple:</div><div><img src="CMB%20HOD.resources/2CBE97A3-D14A-4A67-945C-627A71DF38E4.png" height="526" width="989"/><br/></div><div><br/></div><div><br/></div><div>Putting some of these factors in and looking at the original plots, unfortunately not as simple as this seems.</div><div>Phi-phi (ell=1000):</div><div><img src="CMB%20HOD.resources/03F9B53E-C050-4754-B0F0-7CF6FF4B566F.png" height="535" width="973"/><br/></div><div>Gets pretty close at lower redshifts, but is wrong at high z, and this depends on mass as well.</div><div>For y-y (ell=1000) looks much better:</div><div><br/></div><div><img src="CMB%20HOD.resources/DBCD359C-2E14-4A97-8D97-184685A2EBB7.png" height="526" width="967"/><br/></div><div><br/></div><div><br/></div><div>Checking my HMF against the online calculator, it seems my redshift evolution isn’t quite right…</div><div>Underlying the calculation is the power spectrum, and I do verify that our power spectra are basically identical (white mine, red HMFs, life styles go from z==~0 (solid) to z~5 (dot-dot-dash)):</div><div><img src="CMB%20HOD.resources/3408B569-C630-4922-B679-EAA83A8AB19E.png" height="516" width="718"/><br/></div><div>Despite that, the HMF is different and gets worse with increasing redshift:</div><div><img src="CMB%20HOD.resources/E1CD9EB5-14DC-4898-BD6D-CFCAF61CC106.png" height="525" width="717"/><br/></div><div>The amplitude of mine is lower, and gets lower with higher redshift - which could explain (partly anyway) way my redshift dependence is more off at higher z.</div><div><br/></div><div>The issue is definitely in my HMF code because my sigma_M agrees exactly with the online HMF calc as well:</div><div><img src="CMB%20HOD.resources/C16F5256-E4DE-455F-A28A-D34BC903CF3B.png" height="688" width="1110"/><br/></div><div>Actually remarkable how spot on these are:</div><div><img src="CMB%20HOD.resources/D36BA644-96D8-40D7-8A8B-B3864191A329.png" height="728" width="1242"/><br/></div><div><br/></div><div><br/></div><div>Ok, there was a slight bug in the rho_crit term - so things are better but still not quite right:</div><div><img src="CMB%20HOD.resources/AA35D7CC-740D-4777-AEF3-F4BECD7BC074.png" height="664" width="1170"/><br/></div><div>Doesn’t look like much, but still increasingly wrong with redshift, up to ~30% by z=5:</div><div><img src="CMB%20HOD.resources/C0960522-CBEC-4E11-A888-C701E9B87254.png" height="726" width="1214"/><br/></div><div>(the zig-zagging is just due to quick linear interpolation)</div><div><br/></div><div>And it’s definitely something in the T10 part, because using my Tinker 08 model I get good agreement (just checked lowest and highest z here):</div><div><img src="CMB%20HOD.resources/81AF94E5-B575-4746-B877-EB7E2F9A5822.png" height="680" width="1174"/><br/></div><div><img src="CMB%20HOD.resources/A1DC043B-E915-4B48-8F5D-F4C03C754003.png" height="726" width="1218"/><br/></div><div>Can also check f(nu), though note that I’m pretty sure HMFcalc files have nu*f(nu) in them despite being labeled f(nu).</div><div>For the T08 model:</div><div><img src="CMB%20HOD.resources/7558BDC1-CDFC-43A5-97C5-FE200431406A.png" height="716" width="1244"/><br/></div><div>I’m really not sure why there is any mass dependence to this, given that sigma_m is nearly identical and the rest is just algebra? Not too bad here, but can imagine extending the high z curve out to M~10^15, it would be way off if that trend continues.</div><div><br/></div><div>Went into the source code for HMFcalc (<a href="https://github.com/steven-murray/hmf/blob/master/hmf/fitting_functions.py">https://github.com/steven-murray/hmf/blob/master/hmf/fitting_functions.py</a>) to see how they handle the normalization issue (the constant alpha in front of f(nu) is supposed to be set such that the integral of b(nu)*f(nu) is one).  Here is that part:</div><div><img src="CMB%20HOD.resources/2E32F1AE-ADF7-4C6F-A67C-CC018C1FD87C.png" height="380" width="1594"/><br/></div><div>I have *no idea* where that long equation comes from in the case that z!=0 or Delta not one of the supplied values. It doesn’t seem to depend on any of the bias parameters. If I integrate over the supplied mass (nu) range, I do not get 1 - though maybe that’s because my range is only from log(M) 5 to 15, which isn’t all the mass.</div><div><br/></div><div>But, if I add that to my code, along with a restriction that for the redshift evolution of all the terms they stay constant above z=3, I do get f close to the HMF calc for all redshifts:</div><div><img src="CMB%20HOD.resources/F8D3EF7B-1C52-459D-9756-BC60C61206DD.png" height="726" width="1232"/><br/></div><div>Though again, since sigma(M) is spot on, am having a hard time understanding why there is any z and/or M dependence here.</div><div><br/></div><div>Through to the final HMF with the evolving delta term:</div><div>f:</div><div><img src="CMB%20HOD.resources/805C8891-641C-415B-9F9F-CF381FCB6743.png" height="720" width="1236"/><br/></div><div>dN/dm:</div><div><img src="CMB%20HOD.resources/DE72BF57-467E-44D0-B3C2-6FAD3292B766.png" height="730" width="1236"/><br/></div><div><br/></div><div><br/></div><div>3/9/18</div><div><hr/><div>So it turns out that this fix of the HMF does improve my results significantly!</div></div><div><br/></div><div><img src="CMB%20HOD.resources/96950576-C067-4935-9A63-73B61C8F1320.png" height="495" width="623"/> </div><div><img src="CMB%20HOD.resources/4292AD45-0C73-4048-BEF0-497CD262B2F6.png" height="493" width="610"/><br/></div><div><img src="CMB%20HOD.resources/D8D0446B-4C38-494D-B327-C15497D951BC.png" height="495" width="614"/><br/></div><div><img src="CMB%20HOD.resources/08B61A07-9E63-4E76-AAE7-BAB44CA94455.png" height="491" width="620"/><br/></div><div>y-y is almost spot on, not quite there yet for phi-phi (and thus cross). I think the issue must be that my HMF is still slightly off, and there may be an issue with the z-dependence of my NFW profile.</div><div>Getting so close on the final though…</div><div><img src="CMB%20HOD.resources/8E9B3A14-6305-4820-AD58-8180A397AB32.png" height="527" width="982"/><br/></div><div><br/></div><div><br/></div><div>Continuing with the HMF, since it’s still quite a bit off at higher redshift. If I go all the way to z~10, *significantly* off particularly at high M, despite sigma(M) still being spot on:</div><div><img src="CMB%20HOD.resources/E025EB12-ECB1-445E-99BD-BD8B1FD9E632.png" height="552" width="986"/><br/></div><div>I really don’t see how this is possible if sigma(M) is right! Driving me crazy.</div><div>This is also not just an issue with the T10 model - T08 effected in the same way…</div><div><br/></div><div>Fixed some small bugs (- to + sign, etc) that now have the f(nu) normalizations looking mostly right at low mass (much closer to 1), but still turning over at high mass…</div><div><br/></div><div>Should make a note that because of differences in interpolation of the fit parameters for different Delta, if you have Delta &lt; 200 (which I do at higher z), there will be a systematic offset from the HMFcalc values.</div><div><br/></div><div>Just a quick check that it’s not the mass interpolation acting funny…pass the HMFcalc masses directly to my code. Get the same result without the wiggles:</div><div><img src="CMB%20HOD.resources/CD98328C-9B71-411F-BEE2-C0EBEB34C391.png" height="728" width="1226"/><br/></div><div><br/></div><div><br/></div><div>5/13/18</div><div><hr/><div>Unable to figure out where me and HMFcalc differ, even after installing the full python version and doing more comparisons.  So, made a new HMF using that calculator to pass into my code, to see how much it matters.</div></div><div><br/></div><div>For y-auto at ell=1000, very little:</div><div><img src="CMB%20HOD.resources/6A874CB4-6DE2-4E6C-9DFA-4A67CA862CA4.png" height="690" width="1166"/> </div><div>But of course, this is dominated by low-z, where we already agree pretty well anyway.</div><div><img src="CMB%20HOD.resources/DF036801-7C46-4E90-804A-1738DA6CE22D.png" height="716" width="1194"/><img src="CMB%20HOD.resources/AAAFF497-966E-4298-908E-04CF6742EB50.png" height="714" width="1176"/><br/></div><div><br/></div><div><br/></div><div>5/14/18</div><div><hr/><div>Another day poking around the code, nothing new found to change…</div></div><div><br/></div><div>Did try re-creating Figure 5 now, which shows C_l integrated over M and z, for different Mass limits.  The figure is normalized by the result over all masses, so any issues with z should divide out, making this a more direct test of my mass dependence (which seems close in the other figure re-creations).</div><div><br/></div><div>Rather than making a full line of &lt;M_cut results, just do at a few different masses - points are mine, lines are digitized from H&amp;S. With each is the ratio between my results and H&amp;S at each mass cut</div><div><br/></div><div>y-y at ell=1000:</div><div> <img src="CMB%20HOD.resources/32797729-02F0-417D-A3B6-EA5C43A45075.png" height="740" width="898"/><br/></div><div>Mine/H&amp;S at M &lt; 15.000000: 0.99707640</div><div>Mine/H&amp;S at M &lt; 14.000000: 0.95041792</div><div>Mine/H&amp;S at M &lt; 13.698970: 0.91252489</div><div>Mine/H&amp;S at M &lt; 12.000000: -0.14434890</div><div>Not bad, but does seem to get worse with decreasing mass - how much is due to digitization noise is hard to say though.</div><div><br/></div><div>phi-phi at ell=1000</div><div><img src="CMB%20HOD.resources/ED9EBAF0-D85F-4F0C-B80F-210554272D1C.png" height="728" width="996"/><br/></div><div>Mine/H&amp;S at M &lt; 15.000000: 1.0034849</div><div>Mine/H&amp;S at M &lt; 14.000000: 0.93077824</div><div>Mine/H&amp;S at M &lt; 13.698970: 0.88632445</div><div>Mine/H&amp;S at M &lt; 12.000000: 0.68994977</div><div><br/></div><div>cross, ell=1000</div><div><img src="CMB%20HOD.resources/66E78BB0-D453-4C63-A4B8-1D0962599973.png" height="734" width="894"/><img src="CMB%20HOD.resources/833C3558-CB8C-4855-B02C-1CB6A0B54A19.png" height="68" width="194"/><br/></div><div>Mine/H&amp;S at M &lt; 15.000000: 0.99868427</div><div>Mine/H&amp;S at M &lt; 14.000000: 0.86213981</div><div>Mine/H&amp;S at M &lt; 13.698970: 0.76653819</div><div>Mine/H&amp;S at M &lt; 12.000000: 0.51339645</div><div><br/></div><div>y-y, ell=100</div><div><img src="CMB%20HOD.resources/A5E9B822-96D4-44B1-B297-446CA0E6BC0D.png" height="730" width="896"/><br/></div><div>Mine/H&amp;S at M &lt; 15.000000: 0.95980062</div><div>Mine/H&amp;S at M &lt; 14.000000: 0.81968202</div><div>Mine/H&amp;S at M &lt; 13.698970: 0.72883457</div><div>Mine/H&amp;S at M &lt; 12.000000: -0.087194704</div><div><br/></div><div>phi-phi, ell=100</div><div><img src="CMB%20HOD.resources/8AE80DE3-5AFD-49E5-BB85-F8C7DB99DD9A.png" height="722" width="886"/><br/></div><div>Mine/H&amp;S at M &lt; 15.000000: 0.99742579</div><div>Mine/H&amp;S at M &lt; 14.000000: 0.96010562</div><div>Mine/H&amp;S at M &lt; 13.698970: 0.93178808</div><div>Mine/H&amp;S at M &lt; 12.000000: 0.76057800</div><div><br/></div><div>cross, ell=100</div><div><img src="CMB%20HOD.resources/2F908E1D-E7FF-4903-869F-DF436531ED56.png" height="722" width="896"/><br/></div><div>Mine/H&amp;S at M &lt; 15.000000: 0.98133993</div><div>Mine/H&amp;S at M &lt; 14.000000: 0.85040888</div><div>Mine/H&amp;S at M &lt; 13.698970: 0.78786648</div><div>Mine/H&amp;S at M &lt; 12.000000: 0.62209115</div><div><br/></div><div><br/></div><div>3/15/18</div><div><hr/><div>Checking how much using the Zheng et al. parameterization of the concentration index vs. the Duffy et al matters, as a function of M and z.  It seems that they change the density profile by several percent on various scales.  The two seem to converge at higher redshift though, meaning this can’t contribute much to my issues in z. </div></div><div><br/></div><div>But, could matter for phi terms in M, which are off (see above). Using Duffy et al. brings me slightly closer to the right mass dependence, but really only by a factor of at best 2%.</div><div><br/></div><div><br/></div><div>3/16/18</div><div><hr/><div>Returning to the conversion between my viral masses to those defined at 200*rho_mean, since my masses seem to still be off a bit.</div></div><div><br/></div><div>According to H&amp;S, use same method as Hill &amp; Pajer (2013; <a href="https://arxiv.org/pdf/1303.4726.pdf">https://arxiv.org/pdf/1303.4726.pdf</a>) to convert masses. This is their equation 4:</div><div><img src="CMB%20HOD.resources/4B5837D7-D9B9-4A78-8A44-14BD459FE86A.png" height="95" width="570"/><br/></div><div>rho_cr can be switched out for rho_mean when needed.</div><div><br/></div><div>This is basically what I was doing for my slow version of the conversion between M_vir and M_200 (both relative to critical), although there I was also converting the concentration index first.  Unfortunately I can’t find a way to do this without having to evaluate the integral at many r values, which is super slow - and need to do it for a bunch of masses and redshifts (even though rho_mean doesn’t change with z, the viral radius and thus the density profile does).</div><div><br/></div><div>Ok, test #1 is to see if that equation and my analytic conversion for a switch from M_vir to M_200 relative to critical give the same answer.  They do!</div><div><br/></div><div>In principle I should be able to use that equation for all of my conversions. Doing it with the integral is slow, but that integral isn’t that complicated - should be able to do it analytically. I’ve done out the integral (with Wolfram’s help), but now I don’t get agreement with answer from other converter…Bug! fixed. Here’s the math:</div><div><img src="CMB%20HOD.resources/B29A9571-9F8B-4660-9FC5-5F80FAF78E0A.png" height="599" width="929"/><br/></div><div><br/></div><div><br/></div><div>3/19/18</div><div><hr/><div>Well, got new HMF (and bias) values using the masses from the new code above for M_mean_200…and now everything is farther off.</div></div><div><br/></div><div>E.g. for the yy autocorrelation at ell=1000, now the M and z dependence looks off here:</div><div><img src="CMB%20HOD.resources/67CE93CE-9CCF-4B94-87EC-B774E72F8B31.png" height="526" width="707"/><br/></div><div>(compared to this previously:</div><div><img src="CMB%20HOD.resources/E6A2E57A-C655-4972-B750-4FDEA784EFC9.png" height="534" width="707"/>)</div><div><br/></div><div>And in the actual M dependence:</div><div><img src="CMB%20HOD.resources/EDCD433B-79D7-4C32-AB97-AB8F993F533C.png" height="513" width="593"/><br/></div><div>(compared to previously</div><div><img src="CMB%20HOD.resources/F9849A89-11E5-4F3B-9361-173AE78A1516.png" height="517" width="594"/>)</div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div>4/3/18</div><div><hr/><div>Still no word from Colin with data/code that might help me get these last details ironed out.</div></div><div><br/></div><div>In the meantime, putting into place what we need for the actual measurement we are trying to do.  Ran my phi_ell code with type set to  “num” for the number density instead of the mass density. These terms have the shape I’d expect them to (I think…):</div><div><img src="CMB%20HOD.resources/171A4BB8-F5BF-4CB9-BEE6-BE9F75B124C9.png" height="690" width="1258"/><br/></div><div><br/></div><div>Since I don’t know what the end result should look like anyway, making those other plots isn’t overly useful. But one good thing to look at is the 2-halo term. I think it’s reasonable to expect that it should be similar to my previous CMB lensing model, although that was not based in any way on a the HOD halo model.</div><div><br/></div><div><br/></div><div>4/5/18</div><div><hr/><div>Well I ran the one and two halo terms, but I have no idea if things are right. The one thing I can compare to is my previous model that we used on our papers, which based on H&amp;S is an approximation of their two-halo term with the limit of ell -&gt; 0 (though I’m not 100% how this works, I haven’t tried to do it out yet). This seems strange though, because they reference e.g. Sherwin et al. 2012 which goes out to ell of a few 1000, certainly not the small ell limit.</div></div><div><br/></div><div>But if I compare to my old model, using both 1 and 2 halo terms (red is old model, solid white new 2halo, dashed white new 1halo, yellow combined):</div><div><img src="CMB%20HOD.resources/D1D2FC61-DD3C-4F03-A11E-4AC4CECC5268.png" height="696" width="1228"/><br/></div><div>So they’re pretty close at small ell which seems right given the small ell limit mentioned, but very quickly diverge.</div><div><br/></div><div>Since I have no idea where else to tweak things, I’ve returned to my HMF and bias calculations, which matter for the new one but not the old (it was just assumed there that b=1). Realizing that the integral over all masses does not give a bias of 1 at all z, not even close.  Note that Tinker et al. parametrize this in terms of nu, not M, but noticed H&amp;S have an equation buried in the text for this as a mass integral:</div><div><img src="CMB%20HOD.resources/D8D76B5B-74EF-4910-81A1-3D6D9640F293.png" height="70" width="422"/><br/></div><div>If I do this for my masses at each z, this is that integral at each z from 0-10:</div><div><img src="CMB%20HOD.resources/1AD5BBD7-C090-4CAC-A99C-0E5C1CFC1348.png" height="730" width="1254"/><br/></div><div>Definitely not 1, and definitely not constant. How much does this effect the issues I have with my z-dependence?</div><div><br/></div><div><br/></div><div>I’ve moved to checking int(b(nu)*f(nu)*dnu) directly…for e.g. at z=0.005, this integral gives me 0.775…so definitely not 1.</div><div><br/></div><div>Comparing my b to Fig 1 of Tinker et al. 2010, bang on:</div><div><img src="CMB%20HOD.resources/174ED9C1-C361-4A4C-A1A5-717F339E7DC5.png" height="718" width="1128"/><br/></div><div><br/></div><div>Using the HMFcalc dNdM at this redshift, get extremely similar result (integral is 0.77)</div><div><br/></div><div>(Note: I’ve discovered that for very low masses (&lt;log(M)~7), my power spectrum doesn’t go to high enough k and sigma_m flattens out. This causes a discrepancy in the HMF at low masses. In most cases this doesn’t matter too much (and in the end does not impact this integral strongly, obviously). But I’m considering writing an IDL wrapper for hmfcalc to avoid these kinds of problems…)</div><div><br/></div><div><br/></div><div>If I extend the mass range further, from 1&lt; log(M) &lt; 20, this integral gets further from 1 - goes to 0.7 and down to 0.5 for the HMF calc (the larger discrepancy is because this goes far below where my sigma_m is flat).</div><div><br/></div><div>Ahhh ok so part of the change is just due to the accuracy of the integral. Converting to an integral of log(nu), I now get consistent results regardless of the mass range (still ~0.78 regardless of which HMF and mass range used).</div><div><br/></div><div>Tinker et al. mention that analytic prescriptions like SMT have this integral constraint built in. Using the SMT models for my HMF and bias, I find an extremely similar value for this integral (~0.76). But, the z dependence is different - at z=5, the integral is ~0.3 for T10, but  ~0.4 for SMT.</div><div><br/></div><div><br/></div><div>4/9/18</div><div><hr/><div>Over the weekend, I calculated a new normalization for the HMF so that the b(nu)f(nu) integral was 1 in my calculations. This is despite the fact that it is not 1 using the Tinker et al. parameters, even at z=0 and Delta=200, meaning the value of alpha is already provided (and doesn’t need to be re-calculated using the integral constraint - which still seems like a big red flag, and I’ve emailed Tinker about but have not heard back.</div></div><div><br/></div><div>But anyway, wanted to see what would happen, so made a a lookup table of new normalization to apply at each z (note that this was always for Delta=200, even though right now I’m back with my evolving Delta model as our correction for the different mass definitions, despite that seeming wrong too!). And the results are…super promising, in the sense that I have better agreement with H&amp;S.</div><div><br/></div><div>Actually great agreement on the y autocorrelation:</div><div><img src="CMB%20HOD.resources/78B2A555-2DF6-4977-995A-702F2749E819.png" height="710" width="1188"/><br/></div><div>Not as good at ell=100, but there it’s really hard to get a good digitization of H&amp;S because it falls so fast.</div><div><br/></div><div>And while phi autocorr isn’t perfect still, it looks a lot better, with significant raise in higher z values:</div><div><img src="CMB%20HOD.resources/36FA2AEC-FF7E-4C8C-B542-1801B0B015F6.png" height="712" width="1176"/><br/></div><div>And at lower ell it is looking pretty close too:</div><div><img src="CMB%20HOD.resources/4BAB325E-A45D-4CCA-AE21-AF14388F812C.png" height="702" width="1196"/><br/></div><div>Possible that doing that re-normalization corrected for Delta NE 200 might make this even better? (UPDATE: it does make it slightly closer, but still not there)</div><div><br/></div><div>In the final result, I’m so close with this setup:</div><div><img src="CMB%20HOD.resources/922B7C94-B5A6-43E9-9B50-514B8D8A3D52.png" height="718" width="1190"/><br/></div><div>Which would be exciting…if I didn’t think there were two obvious mistakes/hacks in how I did it!</div><div><br/></div></body></html>